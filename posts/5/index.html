<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
  <meta charset="utf-8">
  <title>TOO MUCH CODING</title>
  <meta name="author" content="Marcin Grzejszczak">

  
  

  <!-- https://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="https://toomuchcoding.com/posts/5/">
  <link rel="me" href="https://fosstodon.org/@toomuchcoding">
  <link href="/favicon.png" type="image/png" rel="icon">
  <link href="/atom.xml" rel="alternate" title="TOO MUCH CODING" type="application/atom+xml">

  <!-- https://opengraphprotocol.org/ -->
  <meta name="twitter:card" content="summary_large_image">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://toomuchcoding.com/posts/5/">
  <meta property="og:title" content="TOO MUCH CODING">
  <meta property="og:description" content="A blog for coding addicts about Java, Groovy, Buzzword, Spring, Microservices, Buzzword">

  <script src="/javascripts/libs/jquery/jquery-2.1.3.min.js"></script>

<link href="/assets/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="/assets/bootstrap/dist/css/bootstrap-theme.min.css" rel="stylesheet" type="text/css">
<link href="/assets/bootstrap/dist/css/custom.css" rel="stylesheet" type="text/css">




  
  <link href="/stylesheets/screen.css" media="screen, projection, print" rel="stylesheet" type="text/css">

  

</head>

  <body   >
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <div id="wrap">
      <header role="banner">
        <nav class="navbar navbar-default" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" title="toggle navbar" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">TOO MUCH CODING</a>
        </div>

        <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li class="active">
                    <a rel="index" href="/">Blog</a>
                </li>
                <li >
                    <a href="/blog/archives">Archives</a>
                </li>
                <li >
                    <a href="/oss">OSS</a>
                </li>
                <li >
                    <a href="/abstracts">Abstracts</a>
                </li>
                <li >
                    <a href="/talks">Talks</a>
                </li>
                <li >
                    <a href="/publications">Publications</a>
                </li>
                <li >
                    <a href="/bio">Bio</a>
                </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a class="subscribe-rss" href="/atom.xml" title="subscribe via RSS">
                        <span class="visible-xs">RSS</span>
                        <img class="hidden-xs" src="/images/rss.png" alt="RSS">
                    </a>
                </li>
                
            </ul>
            
                <form class="navbar-form navbar-right" action="https://www.google.com/search" method="GET">
                    <input type="hidden" name="sitesearch" value="https://toomuchcoding.com">
                    <div class="form-group">
                        <input class="form-control" type="text" name="q" placeholder="Search">
                    </div>
                </form>
            
        </div>
    </div>
</nav>


      </header>
      <div id="main" role="main" class="container">
        <div id="content">
          <div class="row">
  <div class="page-content col-md-9">
    <div class="blog-index" itemscope itemtype="https://schema.org/Blog">
    <meta itemprop="name" content="TOO MUCH CODING" />
    <meta itemprop="description" content="A blog for coding addicts about Java, Groovy, Buzzword, Spring, Microservices, Buzzword" />
    <meta itemprop="url" content="https://toomuchcoding.com" />
      
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        










<span class="glyphicon glyphicon-calendar"></span> <time datetime="2013-08-09T05:39:00-07:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
           | <a href="/articles/2013/08/09/injecting-test-doubles-in-spring-using/#disqus_thread" itemprop="discussionUrl"
             data-disqus-identifier="https://toomuchcoding.com/articles/2013/08/09/injecting-test-doubles-in-spring-using/">Comments</a>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/articles/2013/08/09/injecting-test-doubles-in-spring-using/" itemprop="url">Injecting Test Doubles in Spring using Mockito and BeanPostProcessors</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><div class='post'>
<br />I'm pretty sure that if you have ever used Spring and are familliar with unit testing, you have encountered a problem related to injecting mocks / spies (Test Doubles) in the Spring's application context which you wouldn't want to modify. This article presents an approach how to solve this issue using Spring's components.<br />
<!--more-->
<br /><a name='more'></a><h2>Project structure</h2>Let's start with the project structure:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-24owAXPWDec/UgS1olJ038I/AAAAAAAABlA/O90115z1yIk/s1600/Project+structure.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="320" src="https://1.bp.blogspot.com/-24owAXPWDec/UgS1olJ038I/AAAAAAAABlA/O90115z1yIk/s320/Project+structure.jpg" width="207" /></a></div><br />As usual to present a problem I'm trying to show a very simple project structure. The approach that I'm about to show could show more benefits if I made the problem more extensive as we had in our project:<br /><br /><ul><li>we had dozens of interfaces and implementations autowired to lists</li><li>we wanted to perform some functional tests basing on the existing Spring application context&nbsp;</li><li>we wanted to verify that for certain input conditions some specific implementation would have their methods executed&nbsp;</li><li>we wanted to stub database access.</li></ul><br />In this example we have a <span style="font-family: Courier New, Courier, monospace;">PlayerService</span> that gets a <span style="font-family: Courier New, Courier, monospace;">Player </span>using a <span style="font-family: Courier New, Courier, monospace;">PlayerWebService</span>. We have an applicationContext that simply defines packages for autowiring:<br /><br /><b>applicationContext.xml</b><br /><br /><pre class="brush:xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;<br />&lt;beans xmlns="https://www.springframework.org/schema/beans"<br />       xmlns:xsi="https://www.w3.org/2001/XMLSchema-instance"<br />       xmlns:context="https://www.springframework.org/schema/context"<br />       xsi:schemaLocation="https://www.springframework.org/schema/beans https://www.springframework.org/schema/beans/spring-beans-3.0.xsd<br />                           https://www.springframework.org/schema/context https://www.springframework.org/schema/context/spring-context-3.0.xsd"&gt;<br /><br />    &lt;context:component-scan base-package="com.blogspot.toomuchcoding"/&gt;<br /><br />&lt;/beans&gt;<br /><br /></pre>Then we have our very simple model:<br /><br /><b>Player.java</b><br /><br /><pre class="brush:java">package com.blogspot.toomuchcoding.model;<br /><br />import java.math.BigDecimal;<br /><br />/**<br /> * User: mgrzejszczak<br /> * Date: 08.08.13<br /> * Time: 14:38<br /> */<br />public final class Player {<br />    private final String playerName;<br />    private final BigDecimal playerValue;<br /><br />    public Player(final String playerName, final BigDecimal playerValue) {<br />        this.playerName = playerName;<br />        this.playerValue = playerValue;<br />    }<br /><br />    public String getPlayerName() {<br />        return playerName;<br />    }<br /><br />    public BigDecimal getPlayerValue() {<br />        return playerValue;<br />    }<br />}<br /><br /></pre><br />the implementation of the <span style="font-family: Courier New, Courier, monospace;">PlayerService </span>that uses <span style="font-family: Courier New, Courier, monospace;">PlayerWebService </span>to retrieve data regarding the <span style="font-family: Courier New, Courier, monospace;">Player</span>:<br /><br /><b>PlayerServiceImpl.java</b><br /><br /><pre class="brush:java">package com.blogspot.toomuchcoding.service;<br /><br />import com.blogspot.toomuchcoding.model.Player;<br />import org.slf4j.Logger;<br />import org.slf4j.LoggerFactory;<br />import org.springframework.beans.factory.annotation.Autowired;<br />import org.springframework.stereotype.Service;<br /><br />/**<br /> * User: mgrzejszczak<br /> * Date: 08.06.13<br /> * Time: 19:02<br /> */<br />@Service<br />public class PlayerServiceImpl implements PlayerService {<br />    private static final Logger LOGGER = LoggerFactory.getLogger(PlayerServiceImpl.class);<br /><br />    @Autowired<br />    private PlayerWebService playerWebService;<br /><br />    @Override<br />    public Player getPlayerByName(String playerName) {<br />        LOGGER.debug(String.format("Logging the player web service name [%s]", playerWebService.getWebServiceName()));<br />        return playerWebService.getPlayerByName(playerName);<br />    }<br /><br />    public PlayerWebService getPlayerWebService() {<br />        return playerWebService;<br />    }<br /><br />    public void setPlayerWebService(PlayerWebService playerWebService) {<br />        this.playerWebService = playerWebService;<br />    }<br />}<br /><br /></pre><br />the implementation of the PlayerWebService that is a provider of data (in this scenario we are simulating awaiting for response):<br /><br /><b>PlayerWebServiceImpl.java</b><br /><br /><pre class="brush:java">package com.blogspot.toomuchcoding.service;<br /><br />import com.blogspot.toomuchcoding.model.Player;<br />import org.slf4j.Logger;<br />import org.slf4j.LoggerFactory;<br />import org.springframework.stereotype.Service;<br /><br />import java.math.BigDecimal;<br /><br />/**<br /> * User: mgrzejszczak<br /> * Date: 08.08.13<br /> * Time: 14:48<br /> */<br />@Service<br />public class PlayerWebServiceImpl implements PlayerWebService {<br />    private static final Logger LOGGER = LoggerFactory.getLogger(PlayerWebServiceImpl.class);<br />    public static final String WEB_SERVICE_NAME = "SuperPlayerWebService";<br />    public static final String SAMPLE_PLAYER_VALUE = "1000";<br /><br />    @Override<br />    public String getWebServiceName() {<br />        return WEB_SERVICE_NAME;<br />    }<br /><br />    @Override<br />    public Player getPlayerByName(String name) {<br />        try {<br />            LOGGER.debug("Simulating awaiting time for a response from a web service");<br />            Thread.sleep(5000);<br />        } catch (InterruptedException e) {<br />            LOGGER.error(String.format("[%s] occurred while trying to make the thread sleep", e));<br />        }<br />        return new Player(name, new BigDecimal(SAMPLE_PLAYER_VALUE));<br />    }<br />}<br /><br /></pre>Perhaps the project structure and the methods are not one of the most brilliant you have ever seen but I wanted to keep it simple to present the problem ;)<br /><br /><h2>The problem</h2>So what actually is the problem? Let us assume that we want our autowired <span style="font-family: Courier New, Courier, monospace;">PlayerWebServiceImpl</span> to be a Spy that we can verify. What is more you don't want to actually change anything in the <span style="font-family: Courier New, Courier, monospace;">applicationContext.xml</span> - you want to use the current version of the Spring context.<br /><br />With mocks it's easier since you can define in your XML file (using Mockito factory method) your bean as a mock to override the original implementation just like this:<br /><br /><pre class="brush:xml">    &lt;bean id="playerWebServiceImpl" class="org.mockito.Mockito" factory-method="mock"&gt;<br />        &lt;constructor-arg value="com.blogspot.toomuchcoding.service.PlayerWebServiceImpl"/&gt;<br />    &lt;/bean&gt;<br /></pre><br />What about the Spy? It's more problematic since in order to create a Spy you need an already existing object of the given type. In our example we have some autowiring going on so we would have to first create a spring bean of the <span style="font-family: Courier New, Courier, monospace;">PlayerWebService </span>type (Spring would have to wire all its dependencies) and then wrap it around with<span style="font-family: Courier New, Courier, monospace;"> Mockito.spy(...)</span> and only then would it have to be wired somewhere else... It's getting very complicatied doesn't it?<br /><h2>The solution</h2>You can see that the problem is not that trivial to be solved. An easy way to fix it however is to use native Spring mechanisms - BeanPostProcessors. You can check my article about how to create a <a href="https://toomuchcoding.blogspot.com/2012/10/spring-beanpostprocessor-for-specified.html">Spring BeanPostProcessor for a specified type</a>&nbsp;- we'll be using it in this example.<br /><br />Let's start with checking the test class:<br /><br /><b>PlayerServiceImplTest.java</b><br /><br /><pre class="brush:java">package com.blogspot.toomuchcoding.service;<br /><br />import com.blogspot.toomuchcoding.model.Player;<br />import org.junit.Test;<br />import org.junit.runner.RunWith;<br />import org.springframework.beans.factory.annotation.Autowired;<br />import org.springframework.test.context.ContextConfiguration;<br />import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;<br /><br />import java.math.BigDecimal;<br /><br />import static org.hamcrest.CoreMatchers.is;<br />import static org.junit.Assert.assertThat;<br />import static org.mockito.BDDMockito.doReturn;<br />import static org.mockito.Mockito.verify;<br /><br />/**<br /> * User: mgrzejszczak<br /> * Date: 08.06.13<br /> * Time: 19:26<br /> */<br />@RunWith(SpringJUnit4ClassRunner.class)<br />@ContextConfiguration("classpath:testApplicationContext.xml")<br />public class PlayerServiceImplTest {<br /><br />    public static final String PLAYER_NAME = "Lewandowski";<br />    public static final BigDecimal PLAYER_VALUE = new BigDecimal("35000000");<br /><br />    @Autowired<br />    PlayerWebService playerWebServiceSpy;<br /><br />    @Autowired<br />    PlayerService objectUnderTest;<br /><br />    @Test<br />    public void shouldReturnAPlayerFromPlayerWebService(){<br />        //given<br />        Player referencePlayer = new Player(PLAYER_NAME, PLAYER_VALUE);<br />        doReturn(referencePlayer).when(playerWebServiceSpy).getPlayerByName(PLAYER_NAME);<br /><br />        //when<br />        Player player = objectUnderTest.getPlayerByName(PLAYER_NAME);<br /><br />        //then<br />        assertThat(player, is(referencePlayer));<br />        verify(playerWebServiceSpy).getWebServiceName();<br />        assertThat(playerWebServiceSpy.getWebServiceName(), is(PlayerWebServiceImpl.WEB_SERVICE_NAME));<br />    }<br /><br /><br />}<br /><br /></pre>In this test we want to mock retrieval of <span style="font-family: Courier New, Courier, monospace;">Player </span>from the <span style="font-family: Courier New, Courier, monospace;">PlayerWebService </span>(let's assume that normally it would try to send a request to the outside world - and we wouldn't want that to happen in our scenario) and test that our <span style="font-family: Courier New, Courier, monospace;">PlayerService </span>returns the <span style="font-family: Courier New, Courier, monospace;">Player </span>that we provided in the method stub and what is more we want to perform verification on the Spy that the method <span style="font-family: Courier New, Courier, monospace;">getWebServiceName()</span> has been executed and that it has a very precisely defined return value. In other words we wanted to stub the method <span style="font-family: Courier New, Courier, monospace;">getPlayerByName(...)</span> and wanted to perform verification of the spy by checking the&nbsp;<span style="font-family: Courier New, Courier, monospace;">getWebServiceName()</span><span style="font-family: inherit;">method.</span><br /><br />Let's check the test context:<br /><br /><b>testApplicationContext.xml</b><br /><br /><pre class="brush:xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;<br />&lt;beans xmlns="https://www.springframework.org/schema/beans"<br />       xmlns:xsi="https://www.w3.org/2001/XMLSchema-instance"<br />       xsi:schemaLocation="https://www.springframework.org/schema/beans https://www.springframework.org/schema/beans/spring-beans.xsd"&gt;<br /><br />    &lt;import resource="applicationContext.xml"/&gt;<br />    &lt;bean class="com.blogspot.postprocessor.PlayerWebServicePostProcessor" /&gt;<br />&lt;/beans&gt;<br /></pre><br />The test context is very small since it's importing the current <span style="font-family: Courier New, Courier, monospace;">applicationContext.xml</span> and creating a Bean that is the key feature in this example - the <span style="font-family: Courier New, Courier, monospace;">BeanPostProcessor</span>:<br /><br /><b>PlayerWebServicePostProcessor.java</b><br /><br /><pre class="brush:java">package com.blogspot.postprocessor;<br /><br /><br />import com.blogspot.toomuchcoding.processor.AbstractBeanPostProcessor;<br />import com.blogspot.toomuchcoding.service.PlayerWebService;<br /><br />import static org.mockito.Mockito.spy;<br /><br />/**<br /> * User: mgrzejszczak<br /> * Date: 07.05.13<br /> * Time: 11:30<br /> */<br />public class PlayerWebServicePostProcessor extends AbstractBeanPostProcessor&lt;PlayerWebService&gt; {<br />    public PlayerWebServicePostProcessor() {<br />        super(PlayerWebService.class);<br />    }<br /><br />    @Override<br />    public PlayerWebService doBefore(PlayerWebService bean) {<br />        return spy(bean);<br />    }<br /><br />    @Override<br />    public PlayerWebService doAfter(PlayerWebService bean) {<br />        return bean;<br />    }<br />}<br /><br /></pre>The class is extending the <span style="font-family: Courier New, Courier, monospace;">AbstractBeanPostProcessor </span>that implements the <a href="https://static.springsource.org/spring/docs/3.2.x/javadoc-api/org/springframework/beans/factory/config/BeanPostProcessor.html">BeanPostProcessor </a>interface. The logic behind this class is to register the Class for which one wants to perform some actions either before initialization (<a href="https://static.springsource.org/spring/docs/3.2.x/javadoc-api/org/springframework/beans/factory/config/BeanPostProcessor.html#postProcessBeforeInitialization(java.lang.Object, java.lang.String)">postProcessBeforeInitialization</a>) or after initialization of the bean (<a href="https://static.springsource.org/spring/docs/3.2.x/javadoc-api/org/springframework/beans/factory/config/BeanPostProcessor.html#postProcessAfterInitialization(java.lang.Object, java.lang.String)">postProcessAfterInitialization</a>). The AbstractBeanPostProcessor is well explained in my post&nbsp;<a href="https://toomuchcoding.blogspot.com/2012/10/spring-beanpostprocessor-for-specified.html">Spring BeanPostProcessor for a specified type</a>&nbsp;but there is one slight change - in my old post we were allowed by the abstraction to perform some actions on the bean without the possibility of returning a wrapper or a proxy on the bean.<br /><br />As you can see in the case of <span style="font-family: Courier New, Courier, monospace;">PlayerWebServicePostProcessor</span>&nbsp;before initialization we are creating a Spy using <span style="font-family: Courier New, Courier, monospace;">Mockito.spy(...)</span> method. In this way we create a factory hook on the intialization of beans of given type - it's as simple as that. This method will be executed for all the classes that implement the <span style="font-family: Courier New, Courier, monospace;">PlayerWebService&nbsp;</span>interface.<br /><h2>Other possibilities</h2><div>While checking out current solutions to this problem I have encountered the <a href="https://bitbucket.org/kubek2k/springockito/wiki/Home">Springockito library</a>&nbsp;by Jakub Janczak.</div><div><br /></div><div>I haven't been using this so I don't know what are (if there are any ;) ) production issues related to this library but it seems really nice and intuitive - great job Jakub! Still, you become dependent on the external library whereas in this example I've shown how to deal with the issue using Spring.</div><h2>Summary</h2><div>In this post I've shown how to</div><div><ul><li>create mocks for existing beans using XML Spring configuration</li><li>create a BeanPostProcessor implementation that performs logic for a given class of beans</li><li>return Spy (you could also return a Mock) for the given class of bean</li></ul></div><div>Now let's move through the Prons and Cons of my approach:</div><div><b><br /></b></div><div><b>Advantages</b></div><div><ul><li>you use Spring native mechanism to create Test Doubles for your beans</li><li>you are not required to add any additional external dependencies</li><li>if you use the <span style="font-family: Courier New, Courier, monospace;">AbstractBeanPostProcessor</span> you have very little changes to implement</li></ul></div><div><b>Disadvantages</b></div><div><ul><li>you have to be familliar with internal Spring architecture (that it uses BeanPostProcessors) - but is it a disadvantage? ;) - in fact if you use the&nbsp;<span style="font-family: Courier New, Courier, monospace;">AbstractBeanPostProcessor</span>&nbsp;&nbsp;you don't have to be familliar with it - you just have to provide the class type and actions to happen before and after initialization.</li><li>it's less intuitive than annotations like in&nbsp;the&nbsp;<a href="https://bitbucket.org/kubek2k/springockito/wiki/Home">Springockito library</a></li></ul></div><h2>Sources</h2>The sources are available at <a href="https://bitbucket.org/gregorin1987/too-much-coding/src/0e7f9ad4eb4c1d2500562c3634253e26fc1e3a0e/Unit%20Testing/Mockito%20-%20Injecting%20Test%20Doubles%20in%20Spring?at=default">TooMuchCoding BitBucket repository</a> and <a href="https://github.com/marcingrzejszczak/too-much-coding/tree/master/Unit%20Testing/Mockito%20-%20Injecting%20Test%20Doubles%20in%20Spring">TooMuchCoding Github repository</a>.<br /><br /></div>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        










<span class="glyphicon glyphicon-calendar"></span> <time datetime="2013-08-06T04:24:00-07:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
           | <a href="/articles/2013/08/06/spock-return-nested-spies-mocks/#disqus_thread" itemprop="discussionUrl"
             data-disqus-identifier="https://toomuchcoding.com/articles/2013/08/06/spock-return-nested-spies-mocks/">Comments</a>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/articles/2013/08/06/spock-return-nested-spies-mocks/" itemprop="url">Spock - return nested spies / mocks</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><div class='post'>
<br />Hi! Some time ago I have written an article about Mockito and using <a href="https://toomuchcoding.blogspot.com/2013/06/mockito-returndeepstubs-for-jaxb.html">RETURNS_DEEP_STUBS when working with JAXB</a>. Quite recently we have faced a similliar issue with deeply nesetd JAXB and the awesome testing framework written in Groovy called&nbsp;<a href="https://code.google.com/p/spock/">Spock</a>. Natively Spock does not support creating deep stubs or spies so we needed to create a workaround for it and this article will show you how to do it.<br />
<!--more-->
<br /><a name='more'></a><h2>Project structure</h2>We will be working on the same data structure as in the&nbsp;<a href="https://toomuchcoding.blogspot.com/2013/06/mockito-returndeepstubs-for-jaxb.html">RETURNS_DEEP_STUBS when working with JAXB</a>&nbsp;article so the project structure will be quite simillar:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://4.bp.blogspot.com/-3AoyOo8WYuY/UgC3QJ5TuNI/AAAAAAAABkw/YJzt5EXB10s/s1600/Spock+Deep+Stubs+project+structure.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="320" src="https://4.bp.blogspot.com/-3AoyOo8WYuY/UgC3QJ5TuNI/AAAAAAAABkw/YJzt5EXB10s/s320/Spock+Deep+Stubs+project+structure.jpg" width="191" /></a></div><br />As you can see the main difference is such that the tests are present in the<span style="font-family: Courier New, Courier, monospace;"> /test/groovy/</span> folder instead of <span style="font-family: Courier New, Courier, monospace;">/test/java/</span> folder.<br /><h2>Extended Spock Specification</h2>In order to use Spock as a testing framework you have to create Groovy test scripts that extend the Spock Specification class. The details of how to use Spock are available <a href="https://code.google.com/p/spock/wiki/SpockBasics">here</a>. In this project I have created an abstract class that extends Specification and adds two additional methods for creating nested Test Doubles (I don't remember if I haven't seen a prototype of this approach somewhere on the internet).<br /><br /><b>ExtendedSpockSpecification.groovy</b><br /><br /><pre class="brush:java">package com.blogspot.toomuchcoding.spock;<br /><br />import spock.lang.Specification<br /><br />/**<br /> * Created with IntelliJ IDEA.<br /> * User: MGrzejszczak<br /> * Date: 14.06.13<br /> * Time: 15:26<br /> */<br />abstract class ExtendedSpockSpecification extends Specification {<br />    /**<br />     * The method creates nested structure of spies for all the elements present in the property parameter. Those spies are set on the input object.<br />     *<br />     * @param object - object on which you want to create nested spies<br />     * @param property - field accessors delimited by a dot - JavaBean convention<br />     * @return Spy of the last object from the property path<br />     */<br />    protected def createNestedSpies(object, String property) {<br />        def lastObject = object<br />        property.tokenize('.').inject object, { obj, prop -&gt;<br />            if (obj[prop] == null) {<br />                def foundProp = obj.metaClass.properties.find { it.name == prop }<br />                obj[prop] = Spy(foundProp.type)<br />            }<br />            lastObject = obj[prop]<br />        }<br />        lastObject<br />    }<br /><br />    /**<br />     * The method creates nested structure of mocks for all the elements present in the property parameter. Those mocks are set on the input object.<br />     *<br />     * @param object - object on which you want to create nested mocks<br />     * @param property - field accessors delimited by a dot - JavaBean convention<br />     * @return Mock of the last object from the property path<br />     */<br />    protected def createNestedMocks(object, String property) {<br />        def lastObject = object<br />        property.tokenize('.').inject object, { obj, prop -&gt;<br />            def foundProp = obj.metaClass.properties.find { it.name == prop }<br />            def mockedProp = Mock(foundProp.type)<br />            lastObject."${prop}" &gt;&gt; mockedProp<br />            lastObject = mockedProp<br />        }<br />        lastObject<br />    }<br />}<br /><br /></pre>These two methods work in a very simillar manner.<br /><ul><li>Assuming that the&nbsp;method's argument&nbsp;<span style="font-family: Courier New, Courier, monospace;">property </span>&nbsp;looks as follows: <span style="font-family: Courier New, Courier, monospace;">"a.b.c.d"</span> then the methods tokenize the string by <span style="font-family: Courier New, Courier, monospace;">"."</span> and iterate over the array - <span style="font-family: Courier New, Courier, monospace;">["a","b","c","d"]</span>.&nbsp;</li><li>We then iterate over the properties of the <a href="https://groovy.codehaus.org/api/groovy/lang/MetaClass.html">Meta Class</a>&nbsp;to find the one whose name is equal to <span style="font-family: Courier New, Courier, monospace;">prop</span> (for example<span style="font-family: Courier New, Courier, monospace;"> "a"</span>).&nbsp;</li><li>If that is the case we then use Spock's Mock/Spy method to create a Test Double of a given class (type).&nbsp;</li><li>Finally we have to bind the mocked nested element to its parent.&nbsp;</li><ul><li>For the Spy it's easy since we set the value on the parent (<span style="font-family: Courier New, Courier, monospace;">lastObject = obj[prop]</span>).&nbsp;</li><li>For the mocks however we need to use the overloaded <span style="font-family: Courier New, Courier, monospace;">&gt;&gt;</span> operator to record the behavior for our mock - that's why dynamically call the property that is present in the <span style="font-family: Courier New, Courier, monospace;">prop</span> variable (<span style="font-family: Courier New, Courier, monospace;">lastObject."${prop}" &gt;&gt; mockedProp</span>).&nbsp;</li></ul><li>Then we return from the closure the mocked/spied instance and we repeat the process for it</li></ul><div><h2>Class to be tested</h2>Let's take a look at the class to be tested:<br /><br /><b>PlayerServiceImpl.java</b><br /><br /><pre class="brush:java">package com.blogspot.toomuchcoding.service;<br /><br />import com.blogspot.toomuchcoding.model.PlayerDetails;<br /><br />/**<br /> * User: mgrzejszczak<br /> * Date: 08.06.13<br /> * Time: 19:02<br /> */<br />public class PlayerServiceImpl implements PlayerService {<br />    @Override<br />    public boolean isPlayerOfGivenCountry(PlayerDetails playerDetails, String country) {<br />        String countryValue = playerDetails.getClubDetails().getCountry().getCountryCode().getCountryCode().value();<br />        return countryValue.equalsIgnoreCase(country);<br />    }<br />}<br /></pre><h2>The test class</h2>And now the test class:<br /><br /><b>PlayerServiceImplWrittenUsingSpockTest.groovy</b></div><div></div><br /><pre class="brush:java">package com.blogspot.toomuchcoding.service<br /><br />import com.blogspot.toomuchcoding.model.*<br />import com.blogspot.toomuchcoding.spock.ExtendedSpockSpecification<br /><br />/**<br /> * User: mgrzejszczak<br /> * Date: 14.06.13<br /> * Time: 16:06<br /> */<br />class PlayerServiceImplWrittenUsingSpockTest extends ExtendedSpockSpecification {<br /><br />    public static final String COUNTRY_CODE_ENG = "ENG";<br /><br />    PlayerServiceImpl objectUnderTest<br /><br />    def setup(){<br />        objectUnderTest = new PlayerServiceImpl()<br />    }<br /><br />    def "should return true if country code is the same when creating nested structures using groovy"() {<br />        given:<br />            PlayerDetails playerDetails = new PlayerDetails(<br />                    clubDetails: new ClubDetails(<br />                            country: new CountryDetails(<br />                                    countryCode: new CountryCodeDetails(<br />                                            countryCode: CountryCodeType.ENG<br />                                    )<br />                            )<br />                    )<br />            )<br /><br />        when:<br />            boolean playerIsOfGivenCountry = objectUnderTest.isPlayerOfGivenCountry(playerDetails, COUNTRY_CODE_ENG);<br /><br />        then:<br />            playerIsOfGivenCountry<br />    }<br /><br />    def "should return true if country code is the same when creating nested structures using spock mocks - requires CGLIB for non interface types"() {<br />        given:<br />            PlayerDetails playerDetails = Mock()<br />            ClubDetails clubDetails = Mock()<br />            CountryDetails countryDetails = Mock()<br />            CountryCodeDetails countryCodeDetails = Mock()<br />            countryCodeDetails.countryCode &gt;&gt; CountryCodeType.ENG<br />            countryDetails.countryCode &gt;&gt; countryCodeDetails<br />            clubDetails.country &gt;&gt; countryDetails<br />            playerDetails.clubDetails &gt;&gt; clubDetails<br /><br />        when:<br />            boolean playerIsOfGivenCountry = objectUnderTest.isPlayerOfGivenCountry(playerDetails, COUNTRY_CODE_ENG);<br /><br />        then:<br />            playerIsOfGivenCountry<br />    }<br /><br /><br />    def "should return true if country code is the same using ExtendedSpockSpecification's createNestedMocks"() {<br />        given:<br />            PlayerDetails playerDetails = Mock()<br />            CountryCodeDetails countryCodeDetails = createNestedMocks(playerDetails, "clubDetails.country.countryCode")<br />            countryCodeDetails.countryCode &gt;&gt; CountryCodeType.ENG<br /><br />        when:<br />            boolean playerIsOfGivenCountry = objectUnderTest.isPlayerOfGivenCountry(playerDetails, COUNTRY_CODE_ENG);<br /><br />        then:<br />            playerIsOfGivenCountry<br />    }<br /><br />    def "should return false if country code is not the same using ExtendedSpockSpecification createNestedMocks"() {<br />        given:<br />            PlayerDetails playerDetails = Mock()<br />            CountryCodeDetails countryCodeDetails = createNestedMocks(playerDetails, "clubDetails.country.countryCode")<br />            countryCodeDetails.countryCode &gt;&gt; CountryCodeType.PL<br /><br />        when:<br />            boolean playerIsOfGivenCountry = objectUnderTest.isPlayerOfGivenCountry(playerDetails, COUNTRY_CODE_ENG);<br /><br />        then:<br />            !playerIsOfGivenCountry<br />    }<br /><br />    def "should return true if country code is the same using ExtendedSpockSpecification's createNestedSpies"() {<br />        given:<br />            PlayerDetails playerDetails = Spy()<br />            CountryCodeDetails countryCodeDetails = createNestedSpies(playerDetails, "clubDetails.country.countryCode")<br />            countryCodeDetails.countryCode = CountryCodeType.ENG<br /><br />        when:<br />            boolean playerIsOfGivenCountry = objectUnderTest.isPlayerOfGivenCountry(playerDetails, COUNTRY_CODE_ENG);<br /><br />        then:<br />            playerIsOfGivenCountry<br />    }<br /><br />    def "should return false if country code is not the same using ExtendedSpockSpecification's createNestedSpies"() {<br />        given:<br />            PlayerDetails playerDetails = Spy()<br />            CountryCodeDetails countryCodeDetails = createNestedSpies(playerDetails, "clubDetails.country.countryCode")<br />            countryCodeDetails.countryCode = CountryCodeType.PL<br /><br />        when:<br />            boolean playerIsOfGivenCountry = objectUnderTest.isPlayerOfGivenCountry(playerDetails, COUNTRY_CODE_ENG);<br /><br />        then:<br />            !playerIsOfGivenCountry<br />    }<br /><br /><br />}<br /></pre><br /><b>Let's move through the test methods one by one</b>. First I present the code and then have a quick description of the presented snippet.<br /><br /><pre class="brush:java">    def "should return true if country code is the same when creating nested structures using groovy"() {<br />        given:<br />            PlayerDetails playerDetails = new PlayerDetails(<br />                    clubDetails: new ClubDetails(<br />                            country: new CountryDetails(<br />                                    countryCode: new CountryCodeDetails(<br />                                            countryCode: CountryCodeType.ENG<br />                                    )<br />                            )<br />                    )<br />            )<br /><br />        when:<br />            boolean playerIsOfGivenCountry = objectUnderTest.isPlayerOfGivenCountry(playerDetails, COUNTRY_CODE_ENG);<br /><br />        then:<br />            playerIsOfGivenCountry<br />    }<br /></pre><br />Here you could find the approach of creating nested structures by using the Groovy feature of passing properties to be set in the constructor.<br /><br /><pre class="brush:java">    def "should return true if country code is the same when creating nested structures using spock mocks - requires CGLIB for non interface types"() {<br />        given:<br />            PlayerDetails playerDetails = Mock()<br />            ClubDetails clubDetails = Mock()<br />            CountryDetails countryDetails = Mock()<br />            CountryCodeDetails countryCodeDetails = Mock()<br />            countryCodeDetails.countryCode &gt;&gt; CountryCodeType.ENG<br />            countryDetails.countryCode &gt;&gt; countryCodeDetails<br />            clubDetails.country &gt;&gt; countryDetails<br />            playerDetails.clubDetails &gt;&gt; clubDetails<br /><br />        when:<br />            boolean playerIsOfGivenCountry = objectUnderTest.isPlayerOfGivenCountry(playerDetails, COUNTRY_CODE_ENG);<br /><br />        then:<br />            playerIsOfGivenCountry<br />    }<br /></pre><br />Here you can find a test that creates mocks using Spock - mind you that you need CGLIB as a dependency when you are mocking non interface types.<br /><br /><pre class="brush:java">    def "should return true if country code is the same using ExtendedSpockSpecification's createNestedMocks"() {<br />        given:<br />            PlayerDetails playerDetails = Mock()<br />            CountryCodeDetails countryCodeDetails = createNestedMocks(playerDetails, "clubDetails.country.countryCode")<br />            countryCodeDetails.countryCode &gt;&gt; CountryCodeType.ENG<br /><br />        when:<br />            boolean playerIsOfGivenCountry = objectUnderTest.isPlayerOfGivenCountry(playerDetails, COUNTRY_CODE_ENG);<br /><br />        then:<br />            playerIsOfGivenCountry<br />    }<br /></pre><br />Here you have an example of creating nested mocks using the createNestedMocks method.<br /><br /><pre class="brush:java">    def "should return false if country code is not the same using ExtendedSpockSpecification createNestedMocks"() {<br />        given:<br />            PlayerDetails playerDetails = Mock()<br />            CountryCodeDetails countryCodeDetails = createNestedMocks(playerDetails, "clubDetails.country.countryCode")<br />            countryCodeDetails.countryCode &gt;&gt; CountryCodeType.PL<br /><br />        when:<br />            boolean playerIsOfGivenCountry = objectUnderTest.isPlayerOfGivenCountry(playerDetails, COUNTRY_CODE_ENG);<br /><br />        then:<br />            !playerIsOfGivenCountry<br />    }<br /></pre><br />An example showing that creating nested mocks using the createNestedMocks method really works - should return false for improper country code.<br /><br /><pre class="brush:java">    def "should return true if country code is the same using ExtendedSpockSpecification's createNestedSpies"() {<br />        given:<br />            PlayerDetails playerDetails = Spy()<br />            CountryCodeDetails countryCodeDetails = createNestedSpies(playerDetails, "clubDetails.country.countryCode")<br />            countryCodeDetails.countryCode = CountryCodeType.ENG<br /><br />        when:<br />            boolean playerIsOfGivenCountry = objectUnderTest.isPlayerOfGivenCountry(playerDetails, COUNTRY_CODE_ENG);<br /><br />        then:<br />            playerIsOfGivenCountry<br />    }<br /></pre><br />Here you have an example of creating nested spies using the createNestedSpies method.<br /><br /><pre class="brush:java">    def "should return false if country code is not the same using ExtendedSpockSpecification's createNestedSpies"() {<br />        given:<br />            PlayerDetails playerDetails = Spy()<br />            CountryCodeDetails countryCodeDetails = createNestedSpies(playerDetails, "clubDetails.country.countryCode")<br />            countryCodeDetails.countryCode = CountryCodeType.PL<br /><br />        when:<br />            boolean playerIsOfGivenCountry = objectUnderTest.isPlayerOfGivenCountry(playerDetails, COUNTRY_CODE_ENG);<br /><br />        then:<br />            !playerIsOfGivenCountry<br />    }<br /></pre><br />An example showing that creating nested spies using the createNestedSpies method really works - should return false for improper country code.<br /><br /><h2>Summary</h2>In this post I have shown you how you can create nested mocks and spies using Spock. It can be useful especially when you are working with nested structures such as JAXB. Still you have to bear in mind that those structures to some extend violate the Law of Demeter. If you check my previous article about Mockito you would see that:<br /><blockquote class="tr_bq">We are getting the nested elements from the JAXB generated classes. Although it violates the&nbsp;<a href="https://en.wikipedia.org/wiki/Law_of_Demeter">Law of Demeter</a>&nbsp;it is quite common to call methods of&nbsp;<b>structures</b>&nbsp;because JAXB generated classes are in fact structures so in fact I fully agree with&nbsp;<a href="https://martinfowler.com/articles/mocksArentStubs.html">Martin Fowler that it should be called the Suggestion of Demeter</a>.</blockquote>And in case of this example the idea is the same - we are talking about structures so we don't violate the Law of Demeter.<br /><br /><b>Advantages</b><br /><br /><ul><li>With a single method you can mock/spy nested elements</li><li>Code cleaner than creating tons of objects that you then have to manually set</li></ul><br /><b>Disadvantages</b><br /><br /><ul><li>Your IDE won't help you with providing the property names since the properties are presented as Strings</li><li>You have to set Test Doubles only in the Specification context (and sometimes you want to go outside this scope)</li></ul><br /><h2>Sources</h2>As usual the sources are available at&nbsp;<a href="https://bitbucket.org/gregorin1987/too-much-coding/src/9f0f64d405a0c0b8219043df9b599f60569c1633/Unit%20Testing/Spock%20-%20Deep%20Stubs?at=default">BitBucket</a>&nbsp;and&nbsp;<a href="https://github.com/marcingrzejszczak/too-much-coding/tree/master/Unit%20Testing/Spock%20-%20Deep%20Stubs">GitHub</a>.</div>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        










<span class="glyphicon glyphicon-calendar"></span> <time datetime="2013-07-25T01:25:00-07:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
           | <a href="/articles/2013/07/25/the-essential-drools-cheat-sheet-at/#disqus_thread" itemprop="discussionUrl"
             data-disqus-identifier="https://toomuchcoding.com/articles/2013/07/25/the-essential-drools-cheat-sheet-at/">Comments</a>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/articles/2013/07/25/the-essential-drools-cheat-sheet-at/" itemprop="url">The Essential Drools Cheat Sheet at DZone is out!</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><div class='post'>
Hi! I'm pleased to announce that <a href="https://www.twitter.com/mariofusco">Maro Fusco's</a> and mine DZone Refcard -&nbsp;<a href="https://refcardz.dzone.com/refcardz/drools">The Essential Drools Cheat Sheet</a>&nbsp;is out at <a href="https://refcardz.dzone.com/refcardz/drools">https://refcardz.dzone.com/refcardz/drools</a>. Hope you enjoy it :)</div>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        










<span class="glyphicon glyphicon-calendar"></span> <time datetime="2013-06-12T04:12:00-07:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
           | <a href="/articles/2013/06/12/mockito-extra-interfaces-with/#disqus_thread" itemprop="discussionUrl"
             data-disqus-identifier="https://toomuchcoding.com/articles/2013/06/12/mockito-extra-interfaces-with/">Comments</a>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/articles/2013/06/12/mockito-extra-interfaces-with/" itemprop="url">Mockito - Extra Interfaces with annotations and static methods</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><div class='post'>
<br />In the code I have quite recently came across a really bad piece of code that based on class casting in terms of performing some actions on objects. Of course the code needed to be refactored but sometimes you can't do it / or don't want to do it (and it should be understandable) if first you don't have unit tests of that functionality. In the following post I will show how to test such code, how to refactor it and in fact what I think about such code ;) <div><br /></div><div><a name='more'></a><br />
<!--more-->
</div><div>Let's take a look at the project structure:</div><div><br /></div><div><div class="separator" style="clear: both; text-align: center;"><a href="https://3.bp.blogspot.com/-RpIw1Ccnof8/UbhBR8EHqbI/AAAAAAAABZU/cPRqLAPNCHU/s1600/Mockito+Extra+Interfaces.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="320" src="https://3.bp.blogspot.com/-RpIw1Ccnof8/UbhBR8EHqbI/AAAAAAAABZU/cPRqLAPNCHU/s320/Mockito+Extra+Interfaces.jpg" width="152" /></a></div><span id="goog_1682433447"></span><span id="goog_1682433448"></span><br /></div><div>As presented in the post regarding <a href="https://toomuchcoding.blogspot.com/2013/06/mockito-returndeepstubs-for-jaxb.html">Mocktio RETURNS_DEEP_STUBS Answer for JAXB</a>&nbsp;yet again we have the JAXB generated classes by the JAXB compiler in the <b>com.blogspot.toomuchcoding.model</b> package. Let's ommit the discussion over the <b>pom.xml</b> file since it's exactly the same as in the previous post.<br /><br />In the&nbsp;<b>com.blogspot.toomuchcoding.adapter</b>&nbsp;package we have adapters over the JAXB PlayerDetails class that provides access to the Player interface. There is the<br /><br /><b>CommonPlayerAdapter.java</b><br /><br /><pre class="brush:java">package com.blogspot.toomuchcoding.adapter;<br /><br />import com.blogspot.toomuchcoding.model.Player;<br />import com.blogspot.toomuchcoding.model.PlayerDetails;<br /><br />/**<br /> * User: mgrzejszczak<br /> * Date: 09.06.13<br /> * Time: 15:42<br /> */<br />public class CommonPlayerAdapter implements Player {<br />    private final PlayerDetails playerDetails;<br /><br />    public CommonPlayerAdapter(PlayerDetails playerDetails){<br />        this.playerDetails = playerDetails;<br />    }<br /><br />    @Override<br />    public void run() {<br />        System.out.printf("Run %s. Run!%n", playerDetails.getName());<br />    }<br /><br />    public PlayerDetails getPlayerDetails() {<br />        return playerDetails;<br />    }<br />}<br /><br /></pre><br /><b>DefencePlayerAdapter.java</b><br /><br /><pre class="brush:java">package com.blogspot.toomuchcoding.adapter;<br /><br />import com.blogspot.toomuchcoding.model.DJ;<br />import com.blogspot.toomuchcoding.model.DefensivePlayer;<br />import com.blogspot.toomuchcoding.model.JavaDeveloper;<br />import com.blogspot.toomuchcoding.model.PlayerDetails;<br /><br />/**<br /> * User: mgrzejszczak<br /> * Date: 09.06.13<br /> * Time: 15:42<br /> */<br />public class DefencePlayerAdapter extends CommonPlayerAdapter implements DefensivePlayer, DJ, JavaDeveloper {<br /><br />    public DefencePlayerAdapter(PlayerDetails playerDetails){<br />        super(playerDetails);<br />    }<br /><br />    @Override<br />    public void defend(){<br />        System.out.printf("Defence! %s. Defence!%n", getPlayerDetails().getName());<br />    }<br /><br />    @Override<br />    public void playSomeMusic() {<br />        System.out.println("Oops I did it again...!");<br />    }<br /><br />    @Override<br />    public void doSomeSeriousCoding() {<br />        System.out.println("System.out.println(\"Hello world\");");<br />    }<br />}<br /><br /></pre><b>OffensivePlayerAdapter.java</b><br /><br /><pre class="brush:java">package com.blogspot.toomuchcoding.adapter;<br /><br />import com.blogspot.toomuchcoding.model.OffensivePlayer;<br />import com.blogspot.toomuchcoding.model.PlayerDetails;<br /><br />/**<br /> * User: mgrzejszczak<br /> * Date: 09.06.13<br /> * Time: 15:42<br /> */<br />public class OffensivePlayerAdapter extends CommonPlayerAdapter implements OffensivePlayer {<br /><br />    public OffensivePlayerAdapter(PlayerDetails playerDetails){<br />        super(playerDetails);<br />    }<br /><br />    @Override<br />    public void shoot(){<br />        System.out.printf("%s Shooooot!.%n", getPlayerDetails().getName());<br />    }<br />}<br /><br /></pre>Ok, now let's go to the more interesting part. Let us assume that we have a very simple factory of players:<br /><br /><b>PlayerFactoryImpl.java</b><br /><br /><pre class="brush:java">package com.blogspot.toomuchcoding.factory;<br /><br />import com.blogspot.toomuchcoding.adapter.CommonPlayerAdapter;<br />import com.blogspot.toomuchcoding.adapter.DefencePlayerAdapter;<br />import com.blogspot.toomuchcoding.adapter.OffensivePlayerAdapter;<br />import com.blogspot.toomuchcoding.model.Player;<br />import com.blogspot.toomuchcoding.model.PlayerDetails;<br />import com.blogspot.toomuchcoding.model.PositionType;<br /><br />/**<br /> * User: mgrzejszczak<br /> * Date: 09.06.13<br /> * Time: 15:53<br /> */<br /><br />public class PlayerFactoryImpl implements PlayerFactory {<br /><br />    @Override<br />    public Player createPlayer(PositionType positionType) {<br />        PlayerDetails player = createCommonPlayer(positionType);<br />        switch (positionType){<br />            case ATT:<br />                return new OffensivePlayerAdapter(player);<br />            case MID:<br />                return new OffensivePlayerAdapter(player);<br />            case DEF:<br />                return new DefencePlayerAdapter(player);<br />            case GK:<br />                return new DefencePlayerAdapter(player);<br />            default:<br />                return new CommonPlayerAdapter(player);<br />        }<br />    }<br /><br />    private PlayerDetails createCommonPlayer(PositionType positionType){<br />        PlayerDetails playerDetails = new PlayerDetails();<br />        playerDetails.setPosition(positionType);<br />        return playerDetails;<br />    }<br />}<br /><br /></pre>Ok so we have the factory that builds Players. Let's take a look at the Service that uses the factory:<br /><br /><b>PlayerServiceImpl.java</b><br /><br /><pre class="brush:java">package com.blogspot.toomuchcoding.service;<br /><br />import com.blogspot.toomuchcoding.factory.PlayerFactory;<br />import com.blogspot.toomuchcoding.model.*;<br /><br />/**<br /> * User: mgrzejszczak<br /> * Date: 08.06.13<br /> * Time: 19:02<br /> */<br />public class PlayerServiceImpl implements PlayerService {<br /><br />    private PlayerFactory playerFactory;<br /><br />    @Override<br />    public Player playAGameWithAPlayerOfPosition(PositionType positionType) {<br />        Player player = playerFactory.createPlayer(positionType);<br />        player.run();<br />        performAdditionalActions(player);<br />        return player;<br />    }<br /><br />    private void performAdditionalActions(Player player) {<br />        if(player instanceof OffensivePlayer){<br />            OffensivePlayer offensivePlayer = (OffensivePlayer) player;<br />            performAdditionalActionsForTheOffensivePlayer(offensivePlayer);<br />        }else if(player instanceof DefensivePlayer){<br />            DefensivePlayer defensivePlayer = (DefensivePlayer) player;<br />            performAdditionalActionsForTheDefensivePlayer(defensivePlayer);<br />        }<br />    }<br /><br />    private void performAdditionalActionsForTheOffensivePlayer(OffensivePlayer offensivePlayer){<br />        offensivePlayer.shoot();<br />    }<br /><br />    private void performAdditionalActionsForTheDefensivePlayer(DefensivePlayer defensivePlayer){<br />        defensivePlayer.defend();<br />        try{<br />            DJ dj = (DJ)defensivePlayer;<br />            dj.playSomeMusic();<br />            JavaDeveloper javaDeveloper = (JavaDeveloper)defensivePlayer;<br />            javaDeveloper.doSomeSeriousCoding();<br />        }catch(ClassCastException exception){<br />            System.err.println("Sorry, I can't do more than just play football...");<br />        }<br />    }<br /><br />    public PlayerFactory getPlayerFactory() {<br />        return playerFactory;<br />    }<br /><br />    public void setPlayerFactory(PlayerFactory playerFactory) {<br />        this.playerFactory = playerFactory;<br />    }<br />}<br /><br /></pre>Let's admit it... this code is bad. Internally when you look at it (regardless of the fact whether it used <b>instance of</b> operator or not) you feel that it is evil :) As you can see in the code we have some class casts going on... How on earth can we test it? In the majority of testing frameworks you can't do such class casts on mocks since they are built with the CGLIB library and there can be some ClassCastExceptions thrown. You could still not return mocks and real implementations (assuming that those will not perform any ugly stuff in the construction process) and it could actually work but still - this is bad code :P<br /><br />Mockito comes to the rescue (although you shouldn't overuse this feature - in fact if you need to use it please consider refactoring it) with its <b><a href="https://mockito.googlecode.com/svn/branches/1.8.5/javadoc/org/mockito/MockSettings.html#extraInterfaces(java.lang.Class...)">extraInterfaces</a></b> feature:<br /><br /><h3>extraInterfaces</h3><blockquote><a href="https://mockito.googlecode.com/svn/branches/1.8.5/javadoc/org/mockito/MockSettings.html" title="interface in org.mockito">MockSettings</a> <b>extraInterfaces</b>(java.lang.Class&lt;?&gt;...&nbsp;interfaces)<br />Specifies extra interfaces the mock should implement. Might be useful for legacy code or some corner cases. For background, see issue 51&nbsp;<a href="https://code.google.com/p/mockito/issues/detail?id=51">here</a>This mysterious feature should be used very occasionally. The object under test should know exactly its collaborators &amp; dependencies. If you happen to use it often than please make sure you are really producing simple, clean &amp; readable code.<br />Examples:<br />Foo foo = mock(Foo.class, withSettings().extraInterfaces(Bar.class, Baz.class));<br />//now, the mock implements extra interfaces, so following casting is possible:<br />Bar bar = (Bar) foo;<br />Baz baz = (Baz) foo;<br /><b>Parameters:</b><code>interfaces</code>&nbsp;- extra interfaces the should implement.<br /><b>Returns:</b>settings instance so that you can fluently specify other settings</blockquote><dl><dd></dd><dd><dl></dl></dd><dd><dl><div><br /></div></dl></dd></dl>Now let's take a look at the test:<br /><br /><b>PlayerServiceImplTest.java</b><br /><br /><pre class="brush:java">package com.blogspot.toomuchcoding.service;<br /><br />import com.blogspot.toomuchcoding.factory.PlayerFactory;<br />import com.blogspot.toomuchcoding.model.*;<br />import org.junit.Test;<br />import org.junit.runner.RunWith;<br />import org.mockito.InjectMocks;<br />import org.mockito.Mock;<br />import org.mockito.invocation.InvocationOnMock;<br />import org.mockito.runners.MockitoJUnitRunner;<br />import org.mockito.stubbing.Answer;<br /><br />import static org.hamcrest.CoreMatchers.is;<br />import static org.junit.Assert.assertThat;<br />import static org.mockito.BDDMockito.*;<br /><br />/**<br /> * User: mgrzejszczak<br /> * Date: 08.06.13<br /> * Time: 19:26<br /> */<br />@RunWith(MockitoJUnitRunner.class)<br />public class PlayerServiceImplTest {<br /><br />    @Mock<br />    PlayerFactory playerFactory;<br /><br />    @InjectMocks<br />    PlayerServiceImpl objectUnderTest;<br /><br />    @Mock(extraInterfaces = {DJ.class, JavaDeveloper.class})<br />    DefensivePlayer defensivePlayerWithDjAndJavaDevSkills;<br /><br />    @Mock<br />    DefensivePlayer defensivePlayer;<br /><br />    @Mock<br />    OffensivePlayer offensivePlayer;<br /><br />    @Mock<br />    Player commonPlayer;<br /><br />    @Test<br />    public void shouldReturnOffensivePlayerThatRan() throws Exception {<br />        //given<br />        given(playerFactory.createPlayer(PositionType.ATT)).willReturn(offensivePlayer);<br /><br />        //when<br />        Player createdPlayer = objectUnderTest.playAGameWithAPlayerOfPosition(PositionType.ATT);<br /><br />        //then<br />        assertThat(createdPlayer == offensivePlayer, is(true));<br />        verify(offensivePlayer).run();<br />    }<br /><br />    @Test<br />    public void shouldReturnDefensivePlayerButHeWontBeADjNorAJavaDev() throws Exception {<br />        //given<br />        given(playerFactory.createPlayer(PositionType.GK)).willReturn(defensivePlayer);<br /><br />        //when<br />        Player createdPlayer = objectUnderTest.playAGameWithAPlayerOfPosition(PositionType.GK);<br /><br />        //then<br />        assertThat(createdPlayer == defensivePlayer, is(true));<br />        verify(defensivePlayer).run();<br />        verify(defensivePlayer).defend();<br />        verifyNoMoreInteractions(defensivePlayer);<br />    }<br /><br />    @Test<br />    public void shouldReturnDefensivePlayerBeingADjAndAJavaDev() throws Exception {<br />        //given<br />        given(playerFactory.createPlayer(PositionType.GK)).willReturn(defensivePlayerWithDjAndJavaDevSkills);<br />        doAnswer(new Answer&lt;Object&gt;() {<br />            @Override<br />            public Object answer(InvocationOnMock invocationOnMock) throws Throwable {<br />                System.out.println("Hit me baby one more time!");<br />                return null;<br />            }<br />        }).when(((DJ) defensivePlayerWithDjAndJavaDevSkills)).playSomeMusic();<br />        doAnswer(new Answer&lt;Object&gt;() {<br />            @Override<br />            public Object answer(InvocationOnMock invocationOnMock) throws Throwable {<br />                System.out.println("public static void main(String... args){\n}");<br />                return null;<br />            }<br />        }).when(((JavaDeveloper) defensivePlayerWithDjAndJavaDevSkills)).doSomeSeriousCoding();<br /><br />        //when<br />        Player createdPlayer = objectUnderTest.playAGameWithAPlayerOfPosition(PositionType.GK);<br /><br />        //then<br />        assertThat(createdPlayer == defensivePlayerWithDjAndJavaDevSkills, is(true));<br />        verify(defensivePlayerWithDjAndJavaDevSkills).run();<br />        verify(defensivePlayerWithDjAndJavaDevSkills).defend();<br />        verify((DJ) defensivePlayerWithDjAndJavaDevSkills).playSomeMusic();<br />        verify((JavaDeveloper) defensivePlayerWithDjAndJavaDevSkills).doSomeSeriousCoding();<br />    }<br /><br />    @Test<br />    public void shouldReturnDefensivePlayerBeingADjAndAJavaDevByUsingWithSettings() throws Exception {<br />        //given<br />        DefensivePlayer defensivePlayerWithDjAndJavaDevSkills = mock(DefensivePlayer.class, withSettings().extraInterfaces(DJ.class, JavaDeveloper.class));<br />        given(playerFactory.createPlayer(PositionType.GK)).willReturn(defensivePlayerWithDjAndJavaDevSkills);<br />        doAnswer(new Answer&lt;Object&gt;() {<br />            @Override<br />            public Object answer(InvocationOnMock invocationOnMock) throws Throwable {<br />                System.out.println("Hit me baby one more time!");<br />                return null;<br />            }<br />        }).when(((DJ) defensivePlayerWithDjAndJavaDevSkills)).playSomeMusic();<br />        doAnswer(new Answer&lt;Object&gt;() {<br />            @Override<br />            public Object answer(InvocationOnMock invocationOnMock) throws Throwable {<br />                System.out.println("public static void main(String... args){\n}");<br />                return null;<br />            }<br />        }).when(((JavaDeveloper) defensivePlayerWithDjAndJavaDevSkills)).doSomeSeriousCoding();<br /><br />        //when<br />        Player createdPlayer = objectUnderTest.playAGameWithAPlayerOfPosition(PositionType.GK);<br /><br />        //then<br />        assertThat(createdPlayer == defensivePlayerWithDjAndJavaDevSkills, is(true));<br />        verify(defensivePlayerWithDjAndJavaDevSkills).run();<br />        verify(defensivePlayerWithDjAndJavaDevSkills).defend();<br />        verify((DJ) defensivePlayerWithDjAndJavaDevSkills).playSomeMusic();<br />        verify((JavaDeveloper) defensivePlayerWithDjAndJavaDevSkills).doSomeSeriousCoding();<br />    }<br /><br />    @Test<br />    public void shouldReturnCommonPlayer() throws Exception {<br />        //given<br />        given(playerFactory.createPlayer(null)).willReturn(commonPlayer);<br /><br />        //when<br />        Player createdPlayer = objectUnderTest.playAGameWithAPlayerOfPosition(null);<br /><br />        //then<br />        assertThat(createdPlayer, is(commonPlayer));<br />    }<br />}<br /><br /></pre>There are quite a few tests here so let's take a look at the most interesting ones. &nbsp;But before we do it let's<br /><br />We start with providing the <b>@RunWith(MockitoJUnitRunner.class)</b>&nbsp;annotation which alows us to use the Mockito annotations such as&nbsp;<b>@Mock</b> and <b>@InjectMocks</b>.<br /><br />Speaking of which&nbsp;<b>@Mock</b> annotation creates a Mock whereas&nbsp;<b>@InjectMocks</b> inject all the mocks either by constructor or by setters (that's awesome isn't it? :) ).<br /><br />For the defensive player we are using the extra element of the annotation <b>extraInterfaces </b>that provides additional interfaces for the given Mock. You can also write (what you can find in the <b>shouldReturnDefensivePlayerBeingADjAndAJavaDevByUsingWithSettings</b> test) :<br /><br /><pre class="brush:java">DefensivePlayer defensivePlayerWithDjAndJavaDevSkills = mock(DefensivePlayer.class, withSettings().extraInterfaces(DJ.class, JavaDeveloper.class));<br /><br /></pre>Let's take a closer look at the test that we wrote for the functionality related to the DefensivePlayer and the casting part of the tested function:<br /><br /><pre class="brush:java">@Test<br />    public void shouldReturnDefensivePlayerBeingADjAndAJavaDev() throws Exception {<br />        //given<br />        given(playerFactory.createPlayer(PositionType.GK)).willReturn(defensivePlayerWithDjAndJavaDevSkills);<br />        doAnswer(new Answer&lt;Object&gt;() {<br />            @Override<br />            public Object answer(InvocationOnMock invocationOnMock) throws Throwable {<br />                System.out.println("Hit me baby one more time!");<br />                return null;<br />            }<br />        }).when(((DJ) defensivePlayerWithDjAndJavaDevSkills)).playSomeMusic();<br />        doAnswer(new Answer&lt;Object&gt;() {<br />            @Override<br />            public Object answer(InvocationOnMock invocationOnMock) throws Throwable {<br />                System.out.println("public static void main(String... args){\n}");<br />                return null;<br />            }<br />        }).when(((JavaDeveloper) defensivePlayerWithDjAndJavaDevSkills)).doSomeSeriousCoding();<br /><br />        //when<br />        Player createdPlayer = objectUnderTest.playAGameWithAPlayerOfPosition(PositionType.GK);<br /><br />        //then<br />        assertThat(createdPlayer == defensivePlayerWithDjAndJavaDevSkills, is(true));<br />        verify(defensivePlayerWithDjAndJavaDevSkills).run();<br />        verify(defensivePlayerWithDjAndJavaDevSkills).defend();<br />        verify((DJ) defensivePlayerWithDjAndJavaDevSkills).playSomeMusic();<br />        verify((JavaDeveloper) defensivePlayerWithDjAndJavaDevSkills).doSomeSeriousCoding();<br />    }<br /></pre><br />We are using the <b>BDDMockito</b> static methods like <b>given(...).willReturn(...).willAnswer(...)</b> etc. Then we are stubbing void methods with our custom Anwsers. In the next line you can see that in order to stub methods of another interface you have to cast the mock to the given interface. The same is related to the verification phase where i norder to check if a method was executed you have to cast the mock to the given interface.<br /><br />You could improve the test by returning a real implementation from the factory or if it's a "heavy" operation to create one you could return a mock of such an implementation. What I wanted to show here is how to use the extra interfaces in Mockito (perhaps my usecase is not the best one ;) ). Anyway the implementation presented in the test is bad so we should think of the way to refactor it...<br /><br />One of the ideas could be, assuming that the additional logic done in the Service is a part of the creation of the object, to move the code to the factory as such:<br /><br /><b>PlayFactoryImplWithFieldSettingLogic.java</b><br /><br /><pre class="brush:java">package com.blogspot.toomuchcoding.factory;<br /><br />import com.blogspot.toomuchcoding.adapter.CommonPlayerAdapter;<br />import com.blogspot.toomuchcoding.adapter.DefencePlayerAdapter;<br />import com.blogspot.toomuchcoding.adapter.OffensivePlayerAdapter;<br />import com.blogspot.toomuchcoding.model.*;<br /><br />/**<br /> * User: mgrzejszczak<br /> * Date: 09.06.13<br /> * Time: 15:53<br /> */<br /><br />public class PlayerFactoryImplWithFieldSettingLogic implements PlayerFactory {<br /><br />    @Override<br />    public Player createPlayer(PositionType positionType) {<br />        PlayerDetails player = createCommonPlayer(positionType);<br />        switch (positionType){<br />            case ATT:<br />                return createOffensivePlayer(player);<br />            case MID:<br />                return createOffensivePlayer(player);<br />            case DEF:<br />                return createDefensivePlayer(player);<br />            case GK:<br />                return createDefensivePlayer(player);<br />            default:<br />                return new CommonPlayerAdapter(player);<br />        }<br />    }<br /><br />    private Player createDefensivePlayer(PlayerDetails player) {<br />        DefencePlayerAdapter defencePlayerAdapter = new DefencePlayerAdapter(player);<br />        defencePlayerAdapter.defend();<br />        defencePlayerAdapter.playSomeMusic();<br />        defencePlayerAdapter.doSomeSeriousCoding();<br />        return defencePlayerAdapter;<br />    }<br /><br />    private OffensivePlayer createOffensivePlayer(PlayerDetails player) {<br />        OffensivePlayer offensivePlayer = new OffensivePlayerAdapter(player);<br />        offensivePlayer.shoot();<br />        return offensivePlayer;<br />    }<br /><br />    private PlayerDetails createCommonPlayer(PositionType positionType){<br />        PlayerDetails playerDetails = new PlayerDetails();<br />        playerDetails.setPosition(positionType);<br />        return playerDetails;<br />    }<br />}<br /><br /></pre>In this way there is no casting the code is really clean. And now the PlayerService looks like this:<br /><br /><b>PlayerServiceImplWIthoutUnnecessaryLogic.java</b><br /><br /><pre class="brush:java">package com.blogspot.toomuchcoding.service;<br /><br />import com.blogspot.toomuchcoding.factory.PlayerFactory;<br />import com.blogspot.toomuchcoding.model.*;<br /><br />/**<br /> * User: mgrzejszczak<br /> * Date: 08.06.13<br /> * Time: 19:02<br /> */<br />public class PlayerServiceImplWithoutUnnecessaryLogic implements PlayerService {<br /><br />    private PlayerFactory playerFactory;<br /><br />    /**<br />     * What's the point in having this method then?<br />     * @param positionType<br />     * @return<br />     */<br />    @Override<br />    public Player playAGameWithAPlayerOfPosition(PositionType positionType) {<br />        return playerFactory.createPlayer(positionType);<br />    }<br /><br />    public PlayerFactory getPlayerFactory() {<br />        return playerFactory;<br />    }<br /><br />    public void setPlayerFactory(PlayerFactory playerFactory) {<br />        this.playerFactory = playerFactory;<br />    }<br />}<br /><br /></pre>And the question arises whether there is even any need to have such a method in your code base...<br /><br />Summing it all up I hope that I managed to show how to:<br /><br /><ul><li>Use MockitoJUnitRunner to inject mocks in a clean way</li><li>Use annotations or static methods to add extra interfaces that can be used by your mock</li><li>Use BDDMockito to perform method stubbing</li><li>Stub void methods with custom answer</li><li>Stub and verify methods of the extra interfaces</li><li>Refactor code that is using class casts</li></ul><br />The sources are available at the <a href="https://bitbucket.org/gregorin1987/too-much-coding/src/cab9f99626730e606c7ed354e81d141819351221/Unit%20Testing/Mockito%20-%20With%20Interfaces?at=default">TooMuchCoding Bitbucket</a> repository and <a href="https://github.com/marcingrzejszczak/too-much-coding/tree/master/Unit%20Testing/Mockito%20-%20With%20Interfaces">TooMuchCoding Github</a> repository.<br /><br /><br /><br /><br /></div></div>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        










<span class="glyphicon glyphicon-calendar"></span> <time datetime="2013-06-08T12:10:00-07:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
           | <a href="/articles/2013/06/08/mockito-returndeepstubs-for-jaxb/#disqus_thread" itemprop="discussionUrl"
             data-disqus-identifier="https://toomuchcoding.com/articles/2013/06/08/mockito-returndeepstubs-for-jaxb/">Comments</a>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/articles/2013/06/08/mockito-returndeepstubs-for-jaxb/" itemprop="url">Mockito - RETURNS_DEEP_STUBS for JAXB</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><div class='post'>
<br />Sorry for not having written for some time but I was busy with writing the JBoss Drools Refcard for DZone and I am in the middle of writing a book about Mockito so I don't have too much time left for blogging...<br />
<!--more-->
<br />Anyway quite recently on my current project I had an interesting situation regarding unit testing with Mockito and JAXB structures. We have very deeply nested JAXB structures generated from schemas that are provided for us which means that we can't change it in anyway.<br /><br /><a name='more'></a><br /><br />Let's take a look at the project structure:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-V5rYljCB5V4/UbN2mTKQ_QI/AAAAAAAABY8/C4WL8Tg-9b8/s1600/project_structure.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="320" src="https://1.bp.blogspot.com/-V5rYljCB5V4/UbN2mTKQ_QI/AAAAAAAABY8/C4WL8Tg-9b8/s320/project_structure.jpg" width="173" /></a></div><br />The project structure is pretty simple - there is a <b>Player.xsd</b> schema file that thanks to using the&nbsp;<b>jaxb2-maven-plugin</b>&nbsp;produces the generated JAXB Java classes corresponding to the schema in the <b>target/jaxb/</b> folder in the appropriate package that is defined in the <b>pom.xml</b>. Speaking of which let's take a look at the <b>pom.xml</b> file.<br /><br />The pom.xml :<br /><br /><pre class="brush:xml">&lt;project xmlns="https://maven.apache.org/POM/4.0.0" xmlns:xsi="https://www.w3.org/2001/XMLSchema-instance"<br /> xsi:schemaLocation="https://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;<br /> &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;<br /> &lt;groupId&gt;com.blogspot.toomuchcoding&lt;/groupId&gt;<br /> &lt;artifactId&gt;mockito-deep_stubs&lt;/artifactId&gt;<br /> &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;<br /><br /> &lt;properties&gt;<br />  &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;<br />  &lt;maven.compiler.source&gt;1.6&lt;/maven.compiler.source&gt;<br />  &lt;maven.compiler.target&gt;1.6&lt;/maven.compiler.target&gt;<br /> &lt;/properties&gt;<br /> &lt;repositories&gt;<br />  &lt;repository&gt;<br />   &lt;id&gt;spring-release&lt;/id&gt;<br />   &lt;url&gt;https://maven.springframework.org/release&lt;/url&gt;<br />  &lt;/repository&gt;<br />  &lt;repository&gt;<br />   &lt;id&gt;maven-us-nuxeo&lt;/id&gt;<br />   &lt;url&gt;https://maven-us.nuxeo.org/nexus/content/groups/public&lt;/url&gt;<br />  &lt;/repository&gt;<br /> &lt;/repositories&gt;<br /><br /> &lt;dependencies&gt;<br />  &lt;dependency&gt;<br />   &lt;groupId&gt;junit&lt;/groupId&gt;<br />   &lt;artifactId&gt;junit&lt;/artifactId&gt;<br />   &lt;version&gt;4.10&lt;/version&gt;<br />  &lt;/dependency&gt;<br />  &lt;dependency&gt;<br />            &lt;groupId&gt;org.mockito&lt;/groupId&gt;<br />            &lt;artifactId&gt;mockito-all&lt;/artifactId&gt;<br />            &lt;version&gt;1.9.5&lt;/version&gt;<br />            &lt;scope&gt;test&lt;/scope&gt;<br />        &lt;/dependency&gt;<br /> &lt;/dependencies&gt;<br /> <br /> <br />    &lt;build&gt;<br />        &lt;pluginManagement&gt;<br />            &lt;plugins&gt;<br />                &lt;plugin&gt;<br />                    &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;<br />                    &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;<br />                    &lt;version&gt;2.5.1&lt;/version&gt;<br />                &lt;/plugin&gt;<br />            &lt;/plugins&gt;<br />        &lt;/pluginManagement&gt;<br />        &lt;plugins&gt;<br />            &lt;plugin&gt;<br />                &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt;<br />                &lt;artifactId&gt;jaxb2-maven-plugin&lt;/artifactId&gt;<br />                &lt;version&gt;1.5&lt;/version&gt;<br />                &lt;executions&gt;<br />                    &lt;execution&gt;<br />                        &lt;id&gt;xjc&lt;/id&gt;<br />                        &lt;goals&gt;<br />                            &lt;goal&gt;xjc&lt;/goal&gt;<br />                        &lt;/goals&gt;<br />                    &lt;/execution&gt;<br />                &lt;/executions&gt;<br />                &lt;configuration&gt;<br />                    &lt;packageName&gt;com.blogspot.toomuchcoding.model&lt;/packageName&gt;<br />                    &lt;schemaDirectory&gt;${project.basedir}/src/main/resources/xsd&lt;/schemaDirectory&gt;<br />                &lt;/configuration&gt;<br />            &lt;/plugin&gt;<br />        &lt;/plugins&gt;<br />    &lt;/build&gt;<br /><br />&lt;/project&gt;<br /><br /></pre>Apart from the previously defined project dependencies, as mentioned previously in the <b>jaxb2-maven-plugin</b>&nbsp;in the configuration node you can define the <b>packageName</b> value that defines to which package should the JAXB classes be generated basing on the <b>schemaDirectory</b> value where the plugin can find the proper schema files.<br /><br />Speaking of which let's check the <b>Player.xsd</b> schema file (simillar to the one that was present in the <a href="https://toomuchcoding.blogspot.com/2012/11/spring-jms-message-automatic-conversion.html">Spring JMS automatic message conversion article of mine</a>):<br /><br /><pre class="brush:xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;<br />&lt;xsd:schema xmlns:xsd="https://www.w3.org/2001/XMLSchema"&gt;<br /><br />    &lt;xsd:element name="PlayerDetails"&gt;<br />        &lt;xsd:complexType&gt;<br />            &lt;xsd:sequence&gt;<br />                &lt;xsd:element name="Name" type="xsd:string"/&gt;<br />                &lt;xsd:element name="Surname" type="xsd:string"/&gt;<br />                &lt;xsd:element name="Position" type="PositionType"/&gt;<br />                &lt;xsd:element name="Age" type="xsd:int"/&gt;<br />                &lt;xsd:element name="ClubDetails" type="ClubDetails"/&gt;<br />            &lt;/xsd:sequence&gt;<br />        &lt;/xsd:complexType&gt;<br />    &lt;/xsd:element&gt;<br /><br />    &lt;xsd:complexType name="ClubDetails"&gt;<br />        &lt;xsd:sequence&gt;<br />            &lt;xsd:element name="TeamName" type="xsd:string"/&gt;<br />            &lt;xsd:element name="Country" type="CountryDetails"/&gt;<br />        &lt;/xsd:sequence&gt;<br />    &lt;/xsd:complexType&gt;<br /><br />    &lt;xsd:complexType name="CountryDetails"&gt;<br />        &lt;xsd:sequence&gt;<br />            &lt;xsd:element name="CountryName" type="xsd:string"/&gt;<br />            &lt;xsd:element name="CountryCode" type="CountryCodeDetails"/&gt;<br />        &lt;/xsd:sequence&gt;<br />    &lt;/xsd:complexType&gt;<br /><br />    &lt;xsd:complexType name="CountryCodeDetails"&gt;<br />        &lt;xsd:sequence&gt;<br />            &lt;xsd:element name="CountryName" type="xsd:string"/&gt;<br />            &lt;xsd:element name="CountryCode" type="CountryCodeType"/&gt;<br />        &lt;/xsd:sequence&gt;<br />    &lt;/xsd:complexType&gt;<br /><br />    &lt;xsd:simpleType name="CountryCodeType"&gt;<br />        &lt;xsd:restriction base="xsd:string"&gt;<br />            &lt;xsd:enumeration value="PL"/&gt;<br />            &lt;xsd:enumeration value="GER"/&gt;<br />            &lt;xsd:enumeration value="FRA"/&gt;<br />            &lt;xsd:enumeration value="ENG"/&gt;<br />            &lt;xsd:enumeration value="ESP"/&gt;<br />        &lt;/xsd:restriction&gt;<br />    &lt;/xsd:simpleType&gt;<br /><br />    &lt;xsd:simpleType name="PositionType"&gt;<br />        &lt;xsd:restriction base="xsd:string"&gt;<br />            &lt;xsd:enumeration value="GK"/&gt;<br />            &lt;xsd:enumeration value="DEF"/&gt;<br />            &lt;xsd:enumeration value="MID"/&gt;<br />            &lt;xsd:enumeration value="ATT"/&gt;<br />        &lt;/xsd:restriction&gt;<br />    &lt;/xsd:simpleType&gt;<br /><br />&lt;/xsd:schema&gt;<br /></pre><br />As you can see I'm defining some complex types that even though might have no business sense but you can find such examples in the real life :)<br /><br />Let's find out how the method that we would like to test looks like. Here we have the <b>PlayerServiceImpl</b> that implements the <b>PlayerService</b> interface:<br /><br /><pre class="brush:java">package com.blogspot.toomuchcoding.service;<br /><br />import com.blogspot.toomuchcoding.model.PlayerDetails;<br /><br />/**<br /> * User: mgrzejszczak<br /> * Date: 08.06.13<br /> * Time: 19:02<br /> */<br />public class PlayerServiceImpl implements PlayerService {<br />    @Override<br />    public boolean isPlayerOfGivenCountry(PlayerDetails playerDetails, String country) {<br />        String countryValue = playerDetails.getClubDetails().getCountry().getCountryCode().getCountryCode().value();<br />        return countryValue.equalsIgnoreCase(country);<br />    }<br />}<br /></pre><br />We are getting the nested elements from the JAXB generated classes. Although it violates the <a href="https://en.wikipedia.org/wiki/Law_of_Demeter">Law of Demeter</a>&nbsp;it is quite common to call methods of <b>structures</b>&nbsp;because JAXB generated classes are in fact structures so in fact I fully agree with <a href="https://martinfowler.com/articles/mocksArentStubs.html">Martin Fowler that it should be called the Suggestion of Demeter</a>. Anyway let's see how you could test the method:<br /><br /><pre class="brush:java">    @Test<br />    public void shouldReturnTrueIfCountryCodeIsTheSame() throws Exception {<br />        //given<br />        PlayerDetails playerDetails = new PlayerDetails();<br />        ClubDetails clubDetails = new ClubDetails();<br />        CountryDetails countryDetails = new CountryDetails();<br />        CountryCodeDetails countryCodeDetails = new CountryCodeDetails();<br />        playerDetails.setClubDetails(clubDetails);<br />        clubDetails.setCountry(countryDetails);<br />        countryDetails.setCountryCode(countryCodeDetails);<br />        countryCodeDetails.setCountryCode(CountryCodeType.ENG);<br /><br />        //when<br />        boolean playerOfGivenCountry = objectUnderTest.isPlayerOfGivenCountry(playerDetails, COUNTRY_CODE_ENG);<br /><br />        //then<br />        assertThat(playerOfGivenCountry, is(true));<br />    }<br /></pre>The function checks if, once you have the same Country Code, you get a true boolean from the method. The only problem is the amount of sets and instantiations that take place when you want to create the input message. In our projects we have twice as many nested elements so you can only imagine the number of code that we would have to produce to create the input object...<br /><br />So what can be done to improve this code? Mockito comes to the rescue to together with the <b>RETURN_DEEP_STUBS</b> default answer to the <b><a href="https://docs.mockito.googlecode.com/hg/org/mockito/Mockito.html#mock(java.lang.Class, org.mockito.stubbing.Answer)">Mockito.mock(...)</a></b> method:<br /><br /><pre class="brush:java">  @Test<br />    public void shouldReturnTrueIfCountryCodeIsTheSameUsingMockitoReturnDeepStubs() throws Exception {<br />        //given<br />        PlayerDetails playerDetailsMock = mock(PlayerDetails.class, RETURNS_DEEP_STUBS);<br />        CountryCodeType countryCodeType = CountryCodeType.ENG;<br />        when(playerDetailsMock.getClubDetails().getCountry().getCountryCode().getCountryCode()).thenReturn(countryCodeType);<br /><br />        //when<br />        boolean playerOfGivenCountry = objectUnderTest.isPlayerOfGivenCountry(playerDetailsMock, COUNTRY_CODE_ENG);<br /><br />        //then<br />        assertThat(playerOfGivenCountry, is(true));<br />    }<br /></pre>So what happened here is that you use the <b>Mockito.mock(...)</b> method and provide the <b>RETURNS_DEEP_STUBS</b> answer that will create mocks automatically for you. Mind you that Enums can't be mocked that's why you can't write in the <b>Mockito.when(...)</b> function <b>playerDetailsMock.getClubDetails().getCountry().getCountryCode().getCountryCode().getValue()</b>.<br /><br />Summing it up you can compare the readability of both tests and see how clearer it is to work with JAXB structures by using Mockito <b>RETURNS_DEEP_STUBS</b> default answer.<br /><br />Naturally sources for this example are available at <a href="https://bitbucket.org/gregorin1987/too-much-coding/src/fc1bc010cf16e1f6477391f54e83f8ad446f7608/Unit%20Testing/Mockito%20-%20Deep%20Stubs?at=default">BitBucket</a> and <a href="https://github.com/marcingrzejszczak/too-much-coding/tree/master/Unit%20Testing/Mockito%20-%20Deep%20Stubs">GitHub</a>.<br /><br /><br /></div>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        










<span class="glyphicon glyphicon-calendar"></span> <time datetime="2013-03-30T15:09:00-07:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
           | <a href="/articles/2013/03/30/execution-of-groovy-scripts-from-java/#disqus_thread" itemprop="discussionUrl"
             data-disqus-identifier="https://toomuchcoding.com/articles/2013/03/30/execution-of-groovy-scripts-from-java/">Comments</a>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/articles/2013/03/30/execution-of-groovy-scripts-from-java/" itemprop="url">Execution of Groovy scripts from Java - XmlSlurper and MarkupBuilder in mapping issues</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><div class='post'>
<br /><h2>Problem with mappings</h2><br />In our project we came across a really big problem related to mapping. Having two systems that initially were defined by the BA to be somehwat simillar we have chosen the simple XSLT (done through Altova Mapforce) of the input message to the output one.<br />
<!--more-->
<br />Afterwards it turned out that the functions required to perform a mapping are becoming enormous. An example of such a mapping is:<br /><blockquote class="tr_bq">From the input message take a list of Cars iterate over it and find a Car whose field "prodcutionDate" is the lowest and the attribute "make" is equal to "Honda" and as the output return the "saleDate"</blockquote>So in order to map it we decided to move to JBoss Drools. The <a href="https://toomuchcoding.blogspot.com/2013/02/drools-decision-tables-with-camel-and.html">decision tables</a> were out of question since the logic was to complex and customized to be placed in the spreadsheet so we coded everything in the DRL files. Soon the rules got really big and some of our developers were forced to spend plenty of time on constant recreation of rules stated by the BA.<br /><br />Out of frustration and after having seen all the amazing things at the&nbsp;<a href="https://2013.33degree.org/">33rd degree conference</a> I decided to start finding solutions to my problems which were:<br /><br /><a name='more'></a><br /><ol><li>The DRL files are big and started to become unmaintainable (for a single field we had for example 4 rules)</li><li>Since the BA has never coded a single Drools rule / XSLT &nbsp;in his life adding a simple if... else... statement for him is not a problem</li><li>The BA has to wait for the mapping implementation by the devs until he can test it</li><li>The devs are spending far too much time on coding the mapping rules instead of developing other features</li></ol><div>After stating these problems a research regarding mapping frameworks took place and one of the concepts that I began working on was trying to create the mapping in Groovy. Since Groovy (thanks to for example PropertyMissing and MethodMissing) is a perfect language for creating a DSL I decided to start right away. The only two things I had to remember about were:</div><div><ol><li>The current application is written purely in Java</li><li>The mapping code (in order to perform fast testing) has to be detached from the application as such - it can't be compiled during deployment because we want to have the possibility of frequent substitutions of the mappings</li></ol><div><h2>Project structure&nbsp;</h2><br />Having defined the language, the constraints I created the following solution:</div></div><div><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="https://2.bp.blogspot.com/-LUqaZQkqom4/UVdMZkiW7RI/AAAAAAAABDc/f3sRJ9fF6AM/s1600/Project+structure.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="320" src="https://2.bp.blogspot.com/-LUqaZQkqom4/UVdMZkiW7RI/AAAAAAAABDc/f3sRJ9fF6AM/s320/Project+structure.png" width="255" /></a></div><div><br /></div><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;">The project structure</div><div class="separator" style="clear: both; text-align: center;"><br /></div><div class="separator" style="clear: both; text-align: left;">As you can see the project structure is very simple. To begin with it is built in <b>Gradle</b>. The main function can be found in the <b>XmlTransformer.java</b>. The flow is such that the <b>TransformerFactory</b>&nbsp;creates a <b>Transformer</b>&nbsp;basing on the Groovy script that came out of the <b>ScriptFactory </b>(in our project for different types of products that we distinguish by a field in the XML file, we have different DRL files). The Groovy scripts are residing in the classpath in the <b>/groovy/</b> folder (of course at the end of the day those scripts should be placed outside any jars).&nbsp;</div><div class="separator" style="clear: both; text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: left;">In the <b>build.gradle</b>&nbsp;</div><div class="separator" style="clear: both; text-align: left;"><br /></div><pre class="brush:groovy">apply plugin: 'java'<br /><br />group = 'com.blogspot.toomuchcoding'<br />version = '1.0'<br /><br />repositories {<br />    mavenCentral()<br />}<br /><br />dependencies {<br />    compile 'org.codehaus.groovy:groovy-all:2.0.5'<br />    compile 'org.slf4j:slf4j-log4j12:1.7.2'<br />    compile 'log4j:log4j:1.2.16'<br />    compile 'com.google.guava:guava:14.0'<br /><br />    testCompile group: 'junit', name: 'junit', version: '4.+'<br />}<br /><br />task(executeMain, dependsOn: 'classes', type: JavaExec) {<br />    main = 'com.blogspot.toomuchcoding.XmlTransformer'<br />    classpath = sourceSets.main.runtimeClasspath<br />}<br /></pre><div class="separator" style="clear: both; text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: left;">we can see that there is no groovy plugin -&nbsp;it has been done deliberately since we don't want our scripts to be compiled. Now let's take a look at the logic behind the TransformerFactory that compiles the Groovy script. What is really important is the fact that our Groovy class implements an interface created in our Java project - we want from the Java point of view to have no problems with execution of the Groovy code.</div><div class="separator" style="clear: both; text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: left;"><b>TransformerFactoryImpl.java</b></div><div class="separator" style="clear: both; text-align: left;"><br /></div><pre class="brush:java">package com.blogspot.toomuchcoding.factory;<br /><br />import com.blogspot.toomuchcoding.transformer.Transformer;<br />import com.google.common.io.Resources;<br />import groovy.util.GroovyScriptEngine;<br />import org.slf4j.Logger;<br />import org.slf4j.LoggerFactory;<br /><br />import java.io.File;<br />import java.net.URL;<br /><br />/**<br /> * Created with IntelliJ IDEA.<br /> * User: mgrzejszczak<br /> * Date: 22.03.13<br /> * Time: 23:54<br /> */<br />public class TransformerFactoryImpl implements TransformerFactory&lt;String, String&gt; {<br />    private static final String GROOVY_SCRIPTS_CLASSPATH = "groovy/";<br />    private static Logger LOGGER = LoggerFactory.getLogger(TransformerFactoryImpl.class);<br /><br />    private ScriptFactory scriptFactory;<br />    private GroovyScriptEngine groovyScriptEngine;<br /><br />    public TransformerFactoryImpl(ScriptFactory scriptFactory) {<br />        this.scriptFactory = scriptFactory;<br />        try {<br />            groovyScriptEngine = new GroovyScriptEngine(GROOVY_SCRIPTS_CLASSPATH);<br />        } catch (IOException e) {<br />            LOGGER.error("Exception occurred while trying to create the Groovy script engine", e);<br />            throw new RuntimeException(e);<br />        }<br />    }<br /><br />    @Override<br />    public Transformer&lt;String, String&gt; createTransformer() {<br />        Transformer&lt;String, String&gt; transformerFromScript = null;<br />        try {<br />            File scriptFile = scriptFactory.createScript();<br />            URL scriptAsAClasspathResource = Resources.getResource(GROOVY_SCRIPTS_CLASSPATH + scriptFile.getName());<br />            Class classFromScript = groovyScriptEngine.loadScriptByName(scriptAsAClasspathResource.getFile());<br />            transformerFromScript = (Transformer&lt;String, String&gt;) classFromScript.newInstance();<br />        } catch (Exception e) {<br />            LOGGER.error("Exception occurred while trying to execute Groovy script", e);<br />        }<br />        return transformerFromScript;<br />    }<br /><br />}<br /><br /></pre><div class="separator" style="clear: both; text-align: left;">A <b>GroovyScriptEngine</b>&nbsp;is used to load a script by name. I chose the <a href="https://docs.codehaus.org/display/GROOVY/Embedding+Groovy">GroovyScriptEngine</a> (hopefully I used it in a good way ;) ) &nbsp;because:</div><blockquote class="tr_bq"><span style="background-color: white; font-family: Arial, Helvetica, FreeSans, sans-serif; font-size: 13px; line-height: 17.328125px;">The most complete solution for people who want to embed groovy scripts into their servers and have them reloaded on modification is the GroovyScriptEngine. You initialize the GroovyScriptEngine with a set of CLASSPATH like roots that can be URLs or directory names. You can then execute any Groovy script within those roots. The GSE will also track dependencies between scripts so that if any dependent script is modified the whole tree will be recompiled and reloaded.</span></blockquote><div class="separator" style="clear: both; text-align: left;">I wanted to have some way of caching the compiled classes in order not to have any issues with PermGen.</div><div class="separator" style="clear: both; text-align: left;">Anyway you can see that I am doing some conversions to have the URL of the classpath Groovy script resource. At the end we are extracting a class from the Groovy script and we are casting it to the Transformer.</div><div class="separator" style="clear: both; text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: left;"><b>AbstractGroovyXmlTransformer.groovy</b></div><div class="separator" style="clear: both; text-align: left;"><br /></div><pre class="brush:groovy">package groovy<br /><br />import com.blogspot.toomuchcoding.transformer.Transformer<br />import groovy.util.slurpersupport.NodeChildren<br />import groovy.xml.MarkupBuilder<br /><br />/**<br /> * Created with IntelliJ IDEA.<br /> * User: mgrzejszczak<br /> * Date: 23.03.13<br /> * Time: 02:16<br /> */<br />abstract class AbstractGroovyXmlTransformer implements Transformer&lt;String, String&gt; {<br /><br />    static Map&lt;String, Object&gt; MISSING_PROPERTIES = ["convertDate": new DateConverter(), "map": new Mapper()]<br /><br />    @Override<br />    String transform(String input) {<br />        def inputXml = new XmlSlurper().parseText input<br />        def writer = new StringWriter()<br />        def outputXml = new MarkupBuilder(writer)<br />        doTransform inputXml, outputXml<br />        writer.toString()<br />    }<br /><br />    abstract void doTransform(inputXml, outputXml)<br /><br />    def propertyMissing(String name) {<br />        Object property = MISSING_PROPERTIES[name]<br />        assert property != null, "There is no function like [$name]. The ones that are supported are ${MISSING_PROPERTIES.keySet()}"<br />        property<br />    }<br /><br /><br /><br />    protected static class Mapper {<br />        private Map&lt;String, String&gt; inputParameters<br /><br />        Mapper given(Map inputParameters) {<br />            this.inputParameters = inputParameters<br />            this<br />        }<br /><br />        String from(NodeChildren nodeChildren) {<br />            assert inputParameters != null, "The mapping can't be null!"<br />            assert nodeChildren != null, "Node can't be null!"<br />            String nodeText = nodeChildren.text()<br />            String mappedValue = inputParameters[nodeText]<br />            mappedValue ?: inputParameters.default<br />        }<br /><br />        static Mapper map(Map&lt;String, String&gt; inputParameters) {<br />            return new Mapper(inputParameters)<br />        }<br />    }<br /><br />    protected static class DateConverter {<br />        private String inputDate<br />        private String inputDateFormat<br /><br />        DateConverter from(NodeChildren nodeChildren) {<br />            this.inputDate = nodeChildren.text()<br />            this<br />        }<br /><br />        DateConverter havingDateFormat(String inputDateFormat) {<br />            this.inputDateFormat = inputDateFormat<br />            this<br />        }<br /><br />        String toOutputDateFormat(String outputDateFormat) {<br />            assert inputDate != null, "The input date for which you are trying to do the conversion can't be null"<br />            assert inputDateFormat != null, "The input date format for which you are trying to do the conversion can't be null"<br />            assert outputDateFormat != null, "The output date format for which you are trying to do the conversion can't be null"<br />            Date.parse(inputDateFormat, inputDate).format(outputDateFormat)<br />        }<br /><br />        static DateConverter convertDate() {<br />            new DateConverter()<br />        }<br />    }<br />}</pre><pre class="brush:groovy"></pre><div class="separator" style="clear: both; text-align: left;">In this abstract Groovy class I decided to place all the logic that could blur the image for the BA. In addition to that I created some helper classes and methods. In order to fully use the Groovy's DSL capabilities I used the propertyMissing method to map the words <b>"map"</b> and <b>"convertDate"</b>&nbsp;to create the instances of the helper classes which are used in the <b>Builder</b> design pattern way:</div><div class="separator" style="clear: both; text-align: left;"><br /></div><pre class="brush:groovy">convertDate.from(inputXml.InputSystemContext.InputDate).havingDateFormat("dd/MM/yyyy").toOutputDateFormat("yy/MM/dd")<br /><br />or<br /><br />map.given("Some_action" : "Some_output_action", "default" : "something else").from(inputXml.AdditionalData.TypeOfAction)<br /></pre><div class="separator" style="clear: both; text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: left;">If there is no such "function" (for example a BA makes a typo or sth) then an assertion error is being thrown and a list of supported "function" (which in reality are properties - but they are functions from the BA's perspective) is being printed.&nbsp;</div><div class="separator" style="clear: both; text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: left;">Now let's move to the script that would be used by the BA.</div><div class="separator" style="clear: both; text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: left;"><b>GroovyXmlTransformer.groovy</b></div><div class="separator" style="clear: both; text-align: left;"><br /></div><pre class="brush:groovy">package groovy<br /><br />/**<br /> * Created with IntelliJ IDEA.<br /> * User: mgrzejszczak<br /> * Date: 22.03.13<br /> * Time: 23:59<br /> *<br /> * additional functions:<br /> *<br /> * convertDate.from(Node).havingDateFormat("DateFormat").toOutputDateFormat("AnotherDateFormat")<br /> * map.given("Value to be mapped from" : "Value to be mapped to", "default" : "default value").from(Node)<br /> *<br /> */<br />class GroovyXmlTransformer extends AbstractGroovyXmlTransformer {<br /><br />    @Override<br />    void doTransform(inputXml, outputXml) {<br />        outputXml.OutputSystemEnvelope() {<br />            OutputSystemContext {<br />                ResponseID(inputXml.InputSystemContext.RequestID.text().reverse())<br />                OutputSource('OUTPUT_SYSTEM')<br />                OutputDate(convertDate.from(inputXml.InputSystemContext.InputDate).havingDateFormat("dd/MM/yyyy").toOutputDateFormat("yy/MM/dd"))<br />            }<br />            OutputAdditionalData {<br />                OutputReferenceNo("SOME_PREFIX_${inputXml.AdditionalData.ReferenceNo.text()}_SOME_SUFIX")<br />                OutputTypeOfAction(map.given("Some_action" : "Some_output_action", "default" : "something else").from(inputXml.AdditionalData.TypeOfAction))<br />                OutputTransactions {<br />                    inputXml.AdditionalData.Transactions.Transaction.each {<br />                        OutputTransaction(Client: it.Client, ProductType: it.ProductType, 'Done')<br />                    }<br />                }<br />                OutputProducts {<br />                    def minProduct = inputXml.AdditionalData.Products.Product.list().min { it.Value.text() }<br />                    def maxProduct = inputXml.AdditionalData.Products.Product.list().max { it.Value.text() }<br />                    MinProduct(name: minProduct.Name.text(), minProduct.Value.text())<br />                    MaxProduct(name: maxProduct.Name.text(), maxProduct.Value.text())<br />                }<br />            }<br />        }<br />    }<br />}<br /></pre><div class="separator" style="clear: both; text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: left;">This piece of code does the following mapping (You can check the <b>/xml/SampleXml.xml</b> ):</div><div class="separator" style="clear: both; text-align: left;"><br /></div><div class="datagrid"><table><thead><tr><th>Mapped from</th><th>Mapped to</th></tr></thead><tbody><tr><td>InputSystemEnvelope</td><td>OutputSystemEnvelope</td></tr><tr class="alt"><td>InputSystemContex</td><td>OutputSystemContex</td></tr><tr><td>RequestId</td><td>ResponseId (the Id should be reverted)</td></tr><tr class="alt"><td>InputSource</td><td>OutputSoutce (constant "UTPUT_SYSTEM")</td></tr><tr><td>InputDate</td><td>OutputDate (converted from dd/MM/yyyy to yy/MM/dd) </td></tr><tr class="alt"><td>InputAdditionalData</td><td>OutputAdditionalData</td></tr><tr><td>InputReferenceNo</td><td>OutputReferenceNo ( "SOME_PREFIX_" + value from InputReferenceNo + "_SOME_SUFIX") </td></tr><tr class="alt"><td>InputTypeOfAction</td><td>OutputTypeOfAction (mapped in such a way that if InputTypeOfAction is equal to "Some_action" then we will have "Some_output_action". Otherwise we get "something else")</td></tr><tr><td>Transactions</td><td>OutputTransactions</td></tr><tr class="alt"><td>Transaction</td><td>OutputTransaction ( Attribute Client from Transaction.Client, Attribute ProductType from Transaction.ProductType, and the value "Done")</td></tr><tr><td>Products</td><td>OutputProducts</td></tr><tr class="alt"><td>Product having min value</td><td>MinProduct</td></tr><tr><td>Product having max value</td><td>MaxProduct</td></tr></tbody></table></div><div class="separator" style="clear: both; text-align: left;"><br /></div><h2>The output</h2><div class="separator" style="clear: both; text-align: left;"><br /></div><pre class="brush:xml">Converted from [&lt;InputSystemEnvelope&gt;<br />    &lt;InputSystemContext&gt;<br />        &lt;RequestID&gt;1234567890&lt;/RequestID&gt;<br />        &lt;InputSource&gt;INPUT_SYSTEM&lt;/InputSource&gt;<br />        &lt;InputDate&gt;22/03/2013&lt;/InputDate&gt;<br />    &lt;/InputSystemContext&gt;<br />    &lt;AdditionalData&gt;<br />        &lt;ReferenceNo&gt;Ref1234567&lt;/ReferenceNo&gt;<br />        &lt;TypeOfAction&gt;Some_action&lt;/TypeOfAction&gt;<br />        &lt;Transactions&gt;<br />            &lt;Transaction&gt;<br />                &lt;Client&gt;ACME&lt;/Client&gt;<br />                &lt;ProductType&gt;IRS&lt;/ProductType&gt;<br />            &lt;/Transaction&gt;<br />            &lt;Transaction&gt;<br />                &lt;Client&gt;Oracle&lt;/Client&gt;<br />                &lt;ProductType&gt;DB&lt;/ProductType&gt;<br />            &lt;/Transaction&gt;<br />        &lt;/Transactions&gt;<br />        &lt;Products&gt;<br />            &lt;Product&gt;<br />                &lt;Name&gt;Book&lt;/Name&gt;<br />                &lt;Value&gt;1&lt;/Value&gt;<br />            &lt;/Product&gt;<br />            &lt;Product&gt;<br />                &lt;Name&gt;Car&lt;/Name&gt;<br />                &lt;Value&gt;10000&lt;/Value&gt;<br />            &lt;/Product&gt;<br />            &lt;Product&gt;<br />                &lt;Name&gt;Boat&lt;/Name&gt;<br />                &lt;Value&gt;100000000&lt;/Value&gt;<br />            &lt;/Product&gt;<br />            &lt;Product&gt;<br />                &lt;Name&gt;Spaceship&lt;/Name&gt;<br />                &lt;Value&gt;1000000000000000000&lt;/Value&gt;<br />            &lt;/Product&gt;<br />        &lt;/Products&gt;<br />    &lt;/AdditionalData&gt;<br />&lt;/InputSystemEnvelope&gt;]<br /><br /> to<br /><br />[&lt;OutputSystemEnvelope&gt;<br />  &lt;OutputSystemContext&gt;<br />    &lt;ResponseID&gt;0987654321&lt;/ResponseID&gt;<br />    &lt;OutputSource&gt;OUTPUT_SYSTEM&lt;/OutputSource&gt;<br />    &lt;OutputDate&gt;13/03/22&lt;/OutputDate&gt;<br />  &lt;/OutputSystemContext&gt;<br />  &lt;OutputAdditionalData&gt;<br />    &lt;OutputReferenceNo&gt;SOME_PREFIX_Ref1234567_SOME_SUFIX&lt;/OutputReferenceNo&gt;<br />    &lt;OutputTypeOfAction&gt;Some_output_action&lt;/OutputTypeOfAction&gt;<br />    &lt;OutputTransactions&gt;<br />      &lt;OutputTransaction Client='ACME' ProductType='IRS'&gt;Done&lt;/OutputTransaction&gt;<br />      &lt;OutputTransaction Client='Oracle' ProductType='DB'&gt;Done&lt;/OutputTransaction&gt;<br />    &lt;/OutputTransactions&gt;<br />    &lt;OutputProducts&gt;<br />      &lt;MinProduct name='Book'&gt;1&lt;/MinProduct&gt;<br />      &lt;MaxProduct name='Spaceship'&gt;1000000000000000000&lt;/MaxProduct&gt;<br />    &lt;/OutputProducts&gt;<br />  &lt;/OutputAdditionalData&gt;<br />&lt;/OutputSystemEnvelope&gt;]<br /></pre><div><h2>Pros and cons</h2>The pros and cons of this approach are as follows:<br /><br />Pros:<br /><ul><li>The mapping is done sequentialy - field by field (it is easier to debug the problem)</li><li>The mapping consists of vocabulary understandable by the BA</li><li>Most of mappings could be done by the BA</li><li>The majority of non-mapping grammar is hidden in the abstraction</li><li>The compilation of the Groovy script is faster than creation of KnowledgeBases and compilation of Drools scripts</li><li>Independence on the XML schema (each change of the schema would require the recompilation of the JAXB classes)</li></ul><div>Cons:</div><div><ul><li>The BA would have to have some knowledge from the domain of computer science</li><li>No parallel mapping</li><li>The mapping might get less readable due to the fact that it is highly probable that the BA (out of lack of time) won't create a single function - all the logic will end up in the closures for a given Node.</li><li>There might be some memory issues with parsing and recompilation of the Groovy scripts</li><li>No XML schema may lead to improper output / input XML path setting</li></ul><h2>Summary</h2></div><div>The problem with mapping that we encountered in our project turned out to be a very interesting issue to deal with. The example shown in this post is only a proposition of solving the issue and hopefully could be a starting point to a further discussion on the topic. If you have any ideas or opinions on this topic please leave a comment under <a href="https://toomuchcoding.blogspot.com/2013/03/execution-of-groovy-scripts-from-java.html">this article</a>.</div><div><br /></div><div>The sources can be found on the <a href="https://bitbucket.org/gregorin1987/too-much-coding/src/69f4b59e4452e630670c71150d125e7ea86170aa/Groovy/Mappings?at=default">Too Much Coding BitBucket repository</a> and on <a href="https://github.com/marcingrzejszczak/too-much-coding/tree/master/Groovy/Mappings">GitHub</a>.</div></div></div>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        










<span class="glyphicon glyphicon-calendar"></span> <time datetime="2013-02-03T13:28:00-08:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
           | <a href="/articles/2013/02/03/drools-decision-tables-with-camel-and/#disqus_thread" itemprop="discussionUrl"
             data-disqus-identifier="https://toomuchcoding.com/articles/2013/02/03/drools-decision-tables-with-camel-and/">Comments</a>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/articles/2013/02/03/drools-decision-tables-with-camel-and/" itemprop="url">Drools decision tables with Camel and Spring</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><div class='post'>
<br /><br />Hi!<br /><br /><div style="text-align: justify;">As I've shown it in my previous post <a href="https://toomuchcoding.blogspot.com/2013/01/drools-integration-with-spring-vs.html">JBoss Drools are a very useful rules engine</a>. The only problem is that creating the rules in the Rule language might be pretty complicated for a non-technical person. That's why one can provide an easy way for creating business rules - decision tables created in a spreadsheet!</div><div style="text-align: justify;"><br />
<!--more-->
</div><div style="text-align: justify;">In the following example I will show you a really complicated business rule example converted to a decision table in a spreadsheet. As a backend we will have Drools, Camel and Spring.</div><br /><br /><a name='more'></a><br /><br /><div style="text-align: justify;">To begin with let us take a look at our imaginary business problem. Let us assume that we are running a business that focuses on selling products (either Medical or Electronic). We are shipping our products to several countries (PL, USA, GER, SWE, UK, ESP) and depending on the country there are different law regulations concerning the buyer's age. In some countries you can buy products when you are younger than in others. What is more depending on the country from which the buyer and the product comes from and on the quantity of products, the buyer might get a discount. As you can see there is a substantial number of conditions needed to be fullfield in this scenario (imagine the number of ifs needed to program this :P ).</div><br /><div style="text-align: justify;">Another problem would be the business side (as usual). Anybody who has been working on a project knows how fast the requirements are changing. If one entered all the rules in the code he would have to redeploy the software each time the requirements changed. That's why it is a good practice to divide the business logic from the code itself. Anyway, let's go back to our example.</div><br />To begin with let us take a look at the spreadsheets (before that it is worth taking a look at the <a href="https://docs.jboss.org/drools/release/5.2.0.Final/drools-expert-docs/html/ch06.html">JBoss website with precise description of how the decision table should look like</a>):<br /><br /><br /><div style="text-align: justify;">The point of entry of our program is the first spreadsheet that checks if the given user should be granted with the possibility of buying a product (it will be better if you download the spreadsheets and play with them from Too Much Coding's repository at Bitbucket: <a href="https://bitbucket.org/gregorin1987/too-much-coding/src/eeda79f74a4af30091490ab3507879254540e118/Drools/Decision%20table/src/main/resources/rules/user_table.xls?at=default">user_table.xls</a> and <a href="https://bitbucket.org/gregorin1987/too-much-coding/src/eeda79f74a4af30091490ab3507879254540e118/Drools/Decision%20table/src/main/resources/rules/product_table.xls?at=default">product_table.xls</a>, or Github<a href="https://github.com/marcingrzejszczak/too-much-coding/blob/master/Drools/Decision%20table/src/main/resources/rules/user_table.xls?raw=true"> user_table.xls </a>and <a href="https://github.com/marcingrzejszczak/too-much-coding/blob/master/Drools/Decision%20table/src/main/resources/rules/product_table.xls?raw=true">product_table.xls</a>):</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;"><b>user_table.xls (tables worksheet)</b></div><div style="text-align: justify;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-J5-tXPECwJI/UQ7TmutXq5I/AAAAAAAAAzU/3c9KrRFaZ5w/s1600/user_table.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="120" src="https://1.bp.blogspot.com/-J5-tXPECwJI/UQ7TmutXq5I/AAAAAAAAAzU/3c9KrRFaZ5w/s320/user_table.png" width="320" /></a></div><div><br /></div><div>Once the user has been approved he might get a discount:</div><br /><br /><b>product_table.xls (tables worksheet)</b><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://2.bp.blogspot.com/-v-fAUhcn4HI/UQ69XrrT06I/AAAAAAAAAy0/8fU1nropIhU/s1600/product_table.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="129" src="https://2.bp.blogspot.com/-v-fAUhcn4HI/UQ69XrrT06I/AAAAAAAAAy0/8fU1nropIhU/s320/product_table.png" width="320" /></a></div><br /><b>product_table.xls (lists worksheet)</b><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://4.bp.blogspot.com/-_MkDqjqjuDU/UQ69mEuCy5I/AAAAAAAAAy8/u09czbpift0/s1600/user_table_lists.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="81" src="https://4.bp.blogspot.com/-_MkDqjqjuDU/UQ69mEuCy5I/AAAAAAAAAy8/u09czbpift0/s320/user_table_lists.png" width="320" /></a></div><br /><div class="separator" style="clear: both; text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: justify;">As you can see in the images the business problem is quite complex. Each row represents a rule, and each column represents a condition. <a href="https://toomuchcoding.blogspot.com/2013/01/drools-integration-with-spring-vs.html">Do you remember the rules syntax from my recent post?</a> So you would understand the hidden part of the spreadsheet that is right above the first visible row:</div><div class="separator" style="clear: both; text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="https://2.bp.blogspot.com/--f9FvvQaAhM/UQ6-gcczcQI/AAAAAAAAAzM/GxGmoV6s3OE/s1600/product_table_header.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="71" src="https://2.bp.blogspot.com/--f9FvvQaAhM/UQ6-gcczcQI/AAAAAAAAAzM/GxGmoV6s3OE/s320/product_table_header.png" width="320" /></a></div><div class="separator" style="clear: both; text-align: left;"><br /></div><br /><div style="text-align: justify;">The rows from 2 to 6 represent some fixed configuration values such as rule set, imports (<a href="https://toomuchcoding.blogspot.com/2013/01/drools-integration-with-spring-vs.html"> you've already seen that in my recent post</a>) and functions. Next in row number 7 you can find the name of the RuleTable. Then in row number 8 you have in our scenario either a CONDITION or an ACTION - so in other words either the LHS or rhe RHS respectively. Row number 9 is both representation of types presented in the condition and the binding to a variable. In row number 10 we have the exact LHS condition. Row number 11 shows the label of columns. From row number 12 we have the rules one by one. You can find the spreadsheets in the sources.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Now let's take a look at the code. Let's start with taking a look at the schemas defining the Product and the User.<br /><br /></div><div style="text-align: justify;"><b>Person.xsd</b><br /><br /></div><pre class="brush:xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;<br />&lt;xsd:schema xmlns:xsd="https://www.w3.org/2001/XMLSchema"&gt;<br />    &lt;xsd:include schemaLocation="user.xsd"/&gt;<br /><br />    &lt;xsd:element name="Product"&gt;<br />        &lt;xsd:complexType&gt;<br />            &lt;xsd:sequence&gt;<br />                &lt;xsd:element name="Name" type="xsd:string"/&gt;<br />                &lt;xsd:element name="Type" type="ProductType"/&gt;<br />                &lt;xsd:element name="Price" type="xsd:double"/&gt;<br />                &lt;xsd:element name="CountryOfOrigin" type="CountryType"/&gt;<br />                &lt;xsd:element name="AdditionalInfo" type="xsd:string"/&gt;<br />                &lt;xsd:element name="Quantity" type="xsd:int"/&gt;<br />            &lt;/xsd:sequence&gt;<br />        &lt;/xsd:complexType&gt;<br />    &lt;/xsd:element&gt;<br /><br />    &lt;xsd:simpleType name="ProductType"&gt;<br />        &lt;xsd:restriction base="xsd:string"&gt;<br />            &lt;xsd:enumeration value="MEDICAL"/&gt;<br />            &lt;xsd:enumeration value="ELECTRONIC"/&gt;<br />        &lt;/xsd:restriction&gt;<br />    &lt;/xsd:simpleType&gt;<br /><br />&lt;/xsd:schema&gt;<br /></pre><br /><div style="text-align: justify;"><b>User.xsd</b><br /><br /></div><pre class="brush:xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;<br />&lt;xsd:schema xmlns:xsd="https://www.w3.org/2001/XMLSchema"&gt;<br />    &lt;xsd:include schemaLocation="product.xsd"/&gt;<br /><br />    &lt;xsd:element name="User"&gt;<br />        &lt;xsd:complexType&gt;<br />            &lt;xsd:sequence&gt;<br />                &lt;xsd:element name="UserName" type="xsd:string"/&gt;<br />                &lt;xsd:element name="UserAge" type="xsd:int"/&gt;<br />                &lt;xsd:element name="UserCountry" type="CountryType"/&gt;<br />                &lt;xsd:element name="Decision" type="DecisionType"/&gt;<br />                &lt;xsd:element name="DecisionDescription" type="xsd:string"/&gt;<br />            &lt;/xsd:sequence&gt;<br />        &lt;/xsd:complexType&gt;<br />    &lt;/xsd:element&gt;<br /><br />    &lt;xsd:simpleType name="CountryType"&gt;<br />        &lt;xsd:restriction base="xsd:string"&gt;<br />            &lt;xsd:enumeration value="PL"/&gt;<br />            &lt;xsd:enumeration value="USA"/&gt;<br />            &lt;xsd:enumeration value="GER"/&gt;<br />            &lt;xsd:enumeration value="SWE"/&gt;<br />            &lt;xsd:enumeration value="UK"/&gt;<br />            &lt;xsd:enumeration value="ESP"/&gt;<br />        &lt;/xsd:restriction&gt;<br />    &lt;/xsd:simpleType&gt;<br /><br />    &lt;xsd:simpleType name="DecisionType"&gt;<br />        &lt;xsd:restriction base="xsd:string"&gt;<br />            &lt;xsd:enumeration value="ACCEPTED"/&gt;<br />            &lt;xsd:enumeration value="REJECTED"/&gt;<br />        &lt;/xsd:restriction&gt;<br />    &lt;/xsd:simpleType&gt;<br /><br />&lt;/xsd:schema&gt;<br /></pre><br />Due to the fact that we are using maven we may use a plugin that will convert the XSD into Java classes.<br /><br />part of the <b>pom.xml  </b><br /><br /><pre class="brush:xml"> &lt;build&gt;<br />        &lt;pluginManagement&gt;<br />            &lt;plugins&gt;<br />                &lt;plugin&gt;<br />                    &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;<br />                    &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;<br />                    &lt;version&gt;2.5.1&lt;/version&gt;<br />                &lt;/plugin&gt;<br />            &lt;/plugins&gt;<br />        &lt;/pluginManagement&gt;<br />        &lt;plugins&gt;<br />            &lt;plugin&gt;<br />                &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt;<br />                &lt;artifactId&gt;jaxb2-maven-plugin&lt;/artifactId&gt;<br />                &lt;version&gt;1.5&lt;/version&gt;<br />                &lt;executions&gt;<br />                    &lt;execution&gt;<br />                        &lt;id&gt;xjc&lt;/id&gt;<br />                        &lt;goals&gt;<br />                            &lt;goal&gt;xjc&lt;/goal&gt;<br />                        &lt;/goals&gt;<br />                    &lt;/execution&gt;<br />                &lt;/executions&gt;<br />                &lt;configuration&gt;<br />                    &lt;packageName&gt;pl.grzejszczak.marcin.drools.decisiontable.model&lt;/packageName&gt;<br />                    &lt;schemaDirectory&gt;${project.basedir}/src/main/resources/xsd&lt;/schemaDirectory&gt;<br />                &lt;/configuration&gt;<br />            &lt;/plugin&gt;<br />        &lt;/plugins&gt;<br />    &lt;/build&gt;<br /></pre><br />Thanks to this plugin we have our generated by JAXB classes in the <b>pl.grzejszczak.marcin.decisiontable.model</b> package.<br /><br />Now off to the drools-context.xml file where we've defined all the necessary beans as far as Drools are concerned:<br /><br /><pre class="brush:xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;<br />&lt;beans xmlns="https://www.springframework.org/schema/beans"<br />       xmlns:xsi="https://www.w3.org/2001/XMLSchema-instance"<br />       xmlns:drools="https://drools.org/schema/drools-spring"<br />       xsi:schemaLocation="https://www.springframework.org/schema/beans https://www.springframework.org/schema/beans/spring-beans-3.0.xsd<br />  https://drools.org/schema/drools-spring https://drools.org/schema/drools-spring.xsd"&gt;<br /><br />    &lt;!-- Grid Node identifier that is registered in the CamelContext --&gt;<br />    &lt;drools:grid-node id="node1"/&gt;<br /><br />    &lt;drools:kbase id="productsKBase" node="node1"&gt;<br />        &lt;drools:resources&gt;<br />            &lt;drools:resource type="DTABLE" source="classpath:rules/product_table.xls"/&gt;<br />        &lt;/drools:resources&gt;<br />    &lt;/drools:kbase&gt;<br /><br />    &lt;drools:ksession id="productsKSession" name="productsKSession" type="stateless" kbase="productsKBase" node="node1"/&gt;<br /><br />    &lt;drools:kbase id="usersKBase" node="node1"&gt;<br />        &lt;drools:resources&gt;<br />            &lt;drools:resource type="DTABLE" source="classpath:rules/user_table.xls"/&gt;<br />        &lt;/drools:resources&gt;<br />    &lt;/drools:kbase&gt;<br /><br />    &lt;drools:ksession id="usersKSession" name="usersKSession" type="stateless" kbase="usersKBase" node="node1"/&gt;<br /><br />&lt;/beans&gt;</pre><br /><div style="text-align: justify;">As you can see in comparison to <a href="https://toomuchcoding.blogspot.com/2013/01/drools-integration-with-spring-vs.html">the application context from the recent post </a>there are some differences. First instead of passing the DRL file as the resource inside the knowledge base we are providing the Decision table (<span style="font-family: Courier New, Courier, monospace;">DTABLE</span>). I've decided to pass in two seperate files but you can provide one file with several worksheets and access those worksheets (through the <span style="font-family: Courier New, Courier, monospace;">decisiontable-conf</span> element). Also there is an additional element called <span style="font-family: Courier New, Courier, monospace;">node</span>. We have to choose an implementation of the Node interface (Execution, Grid...) for the Camel route to work properly as you will see in a couple of seconds in the Spring application context file.&nbsp;</div><br /><b>applicationContext.xml</b><br /><br /><pre class="brush:xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;<br />&lt;beans xmlns="https://www.springframework.org/schema/beans"<br />       xmlns:xsi="https://www.w3.org/2001/XMLSchema-instance"<br />       xmlns:camel="https://camel.apache.org/schema/spring"<br />       xmlns:context="https://www.springframework.org/schema/context"<br />       xsi:schemaLocation="https://www.springframework.org/schema/context https://www.springframework.org/schema/context/spring-context-3.0.xsd<br />                           https://www.springframework.org/schema/beans https://www.springframework.org/schema/beans/spring-beans-3.0.xsd<br />                           https://camel.apache.org/schema/spring https://camel.apache.org/schema/spring/camel-spring-2.8.0.xsd"&gt;<br /><br />    &lt;import resource="classpath:drools-context.xml"/&gt;<br />    &lt;!-- Show Spring where to search for the beans (in which packages) --&gt;<br />    &lt;context:component-scan base-package="pl.grzejszczak.marcin.drools.decisiontable" /&gt;<br /><br />    &lt;camel:camelContext id="camelContext"&gt;<br />        &lt;camel:route id="acceptanceRoute"&gt;<br />            &lt;camel:from uri="direct:acceptanceRoute"/&gt;<br />            &lt;camel:to uri="drools:node1/usersKSession"/&gt;<br />        &lt;/camel:route&gt;<br />        &lt;camel:route id="discountRoute"&gt;<br />            &lt;camel:from uri="direct:discountRoute"/&gt;<br />            &lt;camel:to uri="drools:node1/productsKSession"/&gt;<br />        &lt;/camel:route&gt;<br />    &lt;/camel:camelContext&gt;<br /><br />&lt;/beans&gt;<br /><br /></pre><div style="text-align: justify;">As you can see in order to access the Drools Camel Component we have to provide the <b>node </b>through which we will access the proper<b> knowledge session</b>. We have defined two routes - the first one ends at the Drools component that accesses the users knowledge session and the other the products knowledge session.&nbsp;</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">We have a ProductService interface implementation called ProductServiceImpl that given an input User and Product objects pass them through the Camel's Producer Template to two Camel routes each ending at the Drools components. The concept behind this product service is that we are first processing the User if he can even buy the software and then we are checking what kind of a discount he would receive. From the service's point of view in fact we are just sending the object out and waiting for the response. Finally having reveived the response we are passing the User and the Product to the Financial Service implementation that will bill the user for the products that he has bought or reject his offer if needed.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;"><b>ProductServiceImpl.java</b></div><br /><pre class="brush:java">package pl.grzejszczak.marcin.drools.decisiontable.service;<br /><br />import org.apache.camel.CamelContext;<br />import org.slf4j.Logger;<br />import org.slf4j.LoggerFactory;<br />import org.springframework.beans.factory.annotation.Autowired;<br />import org.springframework.stereotype.Component;<br />import pl.grzejszczak.marcin.drools.decisiontable.model.Product;<br />import pl.grzejszczak.marcin.drools.decisiontable.model.User;<br /><br />import static com.google.common.collect.Lists.newArrayList;<br /><br />/**<br /> * Created with IntelliJ IDEA.<br /> * User: mgrzejszczak<br /> * Date: 14.01.13<br /> */<br />@Component("productServiceImpl")<br />public class ProductServiceImpl implements ProductService {<br /><br />    private static final Logger LOGGER = LoggerFactory.getLogger(ProductServiceImpl.class);<br /><br />    @Autowired<br />    CamelContext camelContext;<br /><br />    @Autowired<br />    FinancialService financialService;<br /><br />    @Override<br />    public void runProductLogic(User user, Product product) {<br />        LOGGER.debug("Running product logic - first acceptance Route, then discount Route");<br />        camelContext.createProducerTemplate().sendBody("direct:acceptanceRoute", newArrayList(user, product));<br />        camelContext.createProducerTemplate().sendBody("direct:discountRoute", newArrayList(user, product));<br />        financialService.processOrder(user, product);<br />    }<br /><br />}<br /></pre><pre class="brush:java"></pre><div style="text-align: justify;"><br /></div><span style="text-align: justify;">Another crucial thing to remember about is that the Camel Drools Component requires the Command object as the input. As you can see, in the body we are sending a list of objects (and these are not Command objects). I did it on purpose since in my opinion it is better not to bind our code to a concrete solution. What if we find out that there is a better solution than Drools? Will we change all the code that we have created or just change the Camel route to point at our new solution? That's why Camel has the TypeConverters. We have our own here&nbsp;as well. First of all let's take a look at the implementation.</span><br /><span style="text-align: justify;"><br /></span><span style="text-align: justify;"><b>ProductTypeConverter.java</b></span><br /><span style="text-align: justify;"><br /></span><br /><pre class="brush:java">package pl.grzejszczak.marcin.drools.decisiontable.converter;<br /><br />import org.apache.camel.Converter;<br />import org.drools.command.Command;<br />import org.drools.command.CommandFactory;<br />import org.slf4j.Logger;<br />import org.slf4j.LoggerFactory;<br />import pl.grzejszczak.marcin.drools.decisiontable.model.Product;<br /><br />import java.util.List;<br /><br />/**<br /> * Created with IntelliJ IDEA.<br /> * User: mgrzejszczak<br /> * Date: 30.01.13<br /> * Time: 21:42<br /> */<br />@Converter<br />public class ProductTypeConverter {<br /><br />    private static final Logger LOGGER = LoggerFactory.getLogger(ProductTypeConverter.class);<br /><br />    @Converter<br />    public static Command toCommandFromList(List inputList) {<br />        LOGGER.debug("Executing ProductTypeConverter's toCommandFromList method");<br />        return CommandFactory.newInsertElements(inputList);<br />    }<br /><br />    @Converter<br />    public static Command toCommand(Product product) {<br />        LOGGER.debug("Executing ProductTypeConverter's toCommand method");<br />        return CommandFactory.newInsert(product);<br />    }<br />}<br /><br /></pre><span style="text-align: justify;">There is a good tutorial on TypeConverters on the <a href="https://camel.apache.org/type-converter.html">Camel website</a> - if you needed some more indepth info about it. Anyway, we are annotating our class and the functions used to convert different types into one another. What is important here is that we are showing Camel how to convert a list and a single product to Commands. Due to type erasure this will work regardless of the provided type that is why even though we are giving a list of Product &nbsp;and User, the toCommandFromList function will get executed.&nbsp;</span><br /><span style="text-align: justify;"><br /></span><span style="text-align: justify;">In addition to this in order for the type converter to work we have to provide the fully quallified name of our class (FQN) in the&nbsp;<b>/META-INF/services/org/apache/camel/TypeConverter</b> file.</span><br /><span style="text-align: justify;"><br /></span><span style="text-align: justify;"><b>TypeConverter</b></span><br /><span style="text-align: justify;"><br /></span><br /><pre class="brush:xml">pl.grzejszczak.marcin.drools.decisiontable.converter.ProductTypeConverter</pre><br /><span style="text-align: justify;">In order to properly test our functionality one should write quite a few tests that would verify the rules. A pretty good way would be to have input files stored in the test resources folders that are passed to the rule engine and then the result would be compared against the verified output (unfortunately it is rather impossible to make the business side develop such a reference set of outputs). Anyway let's take a look at the unit test that verifies only a few of the rules and the logs that are produced from running those rules:</span><br /><span style="text-align: justify;"><br /></span><span style="text-align: justify;"><b>ProductServiceImplTest.java</b></span><br /><br /><pre class="brush:java">package pl.grzejszczak.marcin.drools.decisiontable.service.drools;<br /><br />import org.apache.commons.lang.builder.ReflectionToStringBuilder;<br />import org.apache.commons.lang.builder.ToStringStyle;<br />import org.junit.Test;<br />import org.junit.runner.RunWith;<br />import org.slf4j.Logger;<br />import org.slf4j.LoggerFactory;<br />import org.springframework.beans.factory.annotation.Autowired;<br />import org.springframework.test.context.ContextConfiguration;<br />import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;<br />import pl.grzejszczak.marcin.drools.decisiontable.model.*;<br />import pl.grzejszczak.marcin.drools.decisiontable.service.ProductService;<br /><br />import static org.junit.Assert.assertEquals;<br />import static org.junit.Assert.assertTrue;<br /><br />/**<br /> * Created with IntelliJ IDEA.<br /> * User: mgrzejszczak<br /> * Date: 03.02.13<br /> * Time: 16:06<br /> */<br />@RunWith(SpringJUnit4ClassRunner.class)<br />@ContextConfiguration("classpath:applicationContext.xml")<br />public class ProductServiceImplTest {<br /><br />    private static final Logger LOGGER = LoggerFactory.getLogger(ProductServiceImplTest.class);<br /><br />    @Autowired<br />    ProductService objectUnderTest;<br /><br />    @Test<br />    public void testRunProductLogicUserPlUnderageElectronicCountryPL() throws Exception {<br />        int initialPrice = 1000;<br />        int userAge = 6;<br />        int quantity = 10;<br /><br />        User user = createUser("Smith", CountryType.PL, userAge);<br />        Product product = createProduct("Electronic", initialPrice, CountryType.PL, ProductType.ELECTRONIC, quantity);<br /><br />        printInputs(user, product);<br /><br />        objectUnderTest.runProductLogic(user, product);<br /><br />        printInputs(user, product);<br /><br />        assertTrue(product.getPrice() == initialPrice);<br />        assertEquals(DecisionType.REJECTED, user.getDecision());<br />    }<br /><br />    @Test<br />    public void testRunProductLogicUserPlHighAgeElectronicCountryPLLowQuantity() throws Exception {<br />        int initialPrice = 1000;<br />        int userAge = 19;<br />        int quantity = 1;<br /><br />        User user = createUser("Smith", CountryType.PL, userAge);<br />        Product product = createProduct("Electronic", initialPrice, CountryType.PL, ProductType.ELECTRONIC, quantity);<br /><br />        printInputs(user, product);<br /><br />        objectUnderTest.runProductLogic(user, product);<br /><br />        printInputs(user, product);<br /><br />        assertTrue(product.getPrice() == initialPrice);<br />        assertEquals(DecisionType.ACCEPTED, user.getDecision());<br />    }<br /><br />    @Test<br />    public void testRunProductLogicUserPlHighAgeElectronicCountryPLHighQuantity() throws Exception {<br />        int initialPrice = 1000;<br />        int userAge = 19;<br />        int quantity = 8;<br /><br />        User user = createUser("Smith", CountryType.PL, userAge);<br />        Product product = createProduct("Electronic", initialPrice, CountryType.PL, ProductType.ELECTRONIC, quantity);<br /><br />        printInputs(user, product);<br /><br />        objectUnderTest.runProductLogic(user, product);<br /><br />        printInputs(user, product);<br />        double expectedDiscount = 0.1;<br /><br />        assertTrue(product.getPrice() == initialPrice * (1 - expectedDiscount));<br />        assertEquals(DecisionType.ACCEPTED, user.getDecision());<br />    }<br /><br />    @Test<br />    public void testRunProductLogicUserUsaLowAgeElectronicCountryPLHighQuantity() throws Exception {<br />        int initialPrice = 1000;<br />        int userAge = 19;<br />        int quantity = 8;<br /><br />        User user = createUser("Smith", CountryType.USA, userAge);<br />        Product product = createProduct("Electronic", initialPrice, CountryType.PL, ProductType.ELECTRONIC, quantity);<br /><br />        printInputs(user, product);<br /><br />        objectUnderTest.runProductLogic(user, product);<br /><br />        printInputs(user, product);<br /><br />        assertTrue(product.getPrice() == initialPrice);<br />        assertEquals(DecisionType.REJECTED, user.getDecision());<br />    }<br /><br />    @Test<br />    public void testRunProductLogicUserUsaHighAgeMedicalCountrySWELowQuantity() throws Exception {<br />        int initialPrice = 1000;<br />        int userAge = 22;<br />        int quantity = 4;<br /><br />        User user = createUser("Smith", CountryType.USA, userAge);<br />        Product product = createProduct("Some name", initialPrice, CountryType.SWE, ProductType.MEDICAL, quantity);<br /><br />        printInputs(user, product);<br /><br />        objectUnderTest.runProductLogic(user, product);<br /><br />        printInputs(user, product);<br /><br />        assertTrue(product.getPrice() == initialPrice);<br />        assertEquals(DecisionType.ACCEPTED, user.getDecision());<br />    }<br /><br />    @Test<br />    public void testRunProductLogicUserUsaHighAgeMedicalCountrySWEHighQuantity() throws Exception {<br />        int initialPrice = 1000;<br />        int userAge = 22;<br />        int quantity = 8;<br /><br />        User user = createUser("Smith", CountryType.USA, userAge);<br />        Product product = createProduct("Some name", initialPrice, CountryType.SWE, ProductType.MEDICAL, quantity);<br /><br />        printInputs(user, product);<br /><br />        objectUnderTest.runProductLogic(user, product);<br /><br />        printInputs(user, product);<br />        double expectedDiscount = 0.25;<br /><br />        assertTrue(product.getPrice() == initialPrice * (1 - expectedDiscount));<br />        assertEquals(DecisionType.ACCEPTED, user.getDecision());<br />    }<br /><br />    private void printInputs(User user, Product product) {<br />        LOGGER.debug(ReflectionToStringBuilder.reflectionToString(user, ToStringStyle.MULTI_LINE_STYLE));<br />        LOGGER.debug(ReflectionToStringBuilder.reflectionToString(product, ToStringStyle.MULTI_LINE_STYLE));<br />    }<br /><br />    private User createUser(String name, CountryType countryType, int userAge){<br />        User user = new User();<br />        user.setUserName(name);<br />        user.setUserCountry(countryType);<br />        user.setUserAge(userAge);<br />        return user;<br />    }<br /><br />    private Product createProduct(String name, double price, CountryType countryOfOrigin, ProductType productType, int quantity){<br />        Product product = new Product();<br />        product.setPrice(price);<br />        product.setCountryOfOrigin(countryOfOrigin);<br />        product.setName(name);<br />        product.setType(productType);<br />        product.setQuantity(quantity);<br />        return product;<br />    }<br /><br />}<br /><br /></pre><span style="text-align: justify;">Of course the log.debugs in the tests are totally redundant but I wanted you to quickly see that the rules are operational :) Sorry for the length of the logs but I wrote a few tests to show different combinations of rules (in fact it's better too have too many logs than the other way round :) )</span><br /><span style="text-align: justify;"><br /></span><span style="text-align: justify;"><br /></span><br /><pre class="brush:xml">pl.grzejszczak.marcin.drools.decisiontable.service.drools.ProductServiceImplTest:150 pl.grzejszczak.marcin.drools.decisiontable.model.User@1d48043[<br />  userName=Smith<br />  userAge=6<br />  userCountry=PL<br />  decision=&lt;null&gt;<br />  decisionDescription=&lt;null&gt;<br />]<br />pl.grzejszczak.marcin.drools.decisiontable.service.drools.ProductServiceImplTest:151 pl.grzejszczak.marcin.drools.decisiontable.model.Product@1e8f2a0[<br />  name=Electronic<br />  type=ELECTRONIC<br />  price=1000.0<br />  countryOfOrigin=PL<br />  additionalInfo=&lt;null&gt;<br />  quantity=10<br />]<br />pl.grzejszczak.marcin.drools.decisiontable.service.ProductServiceImpl:31 Running product logic - first acceptance Route, then discount Route<br />pl.grzejszczak.marcin.drools.decisiontable.converter.ProductTypeConverter:25 Executing ProductTypeConverter's toCommandFromList method<br />pl.grzejszczak.marcin.drools.decisiontable.service.ProductService:8 Sorry, according to your age (&lt; 18) and country (PL) you can't buy this product<br />pl.grzejszczak.marcin.drools.decisiontable.converter.ProductTypeConverter:25 Executing ProductTypeConverter's toCommandFromList method<br />pl.grzejszczak.marcin.drools.decisiontable.service.FinancialServiceImpl:29 Sorry, user has been rejected...<br />pl.grzejszczak.marcin.drools.decisiontable.service.drools.ProductServiceImplTest:150 pl.grzejszczak.marcin.drools.decisiontable.model.User@1d48043[<br />  userName=Smith<br />  userAge=6<br />  userCountry=PL<br />  decision=REJECTED<br />  decisionDescription=Sorry, according to your age (&lt; 18) and country (PL) you can't buy this product<br />]<br />pl.grzejszczak.marcin.drools.decisiontable.service.drools.ProductServiceImplTest:151 pl.grzejszczak.marcin.drools.decisiontable.model.Product@1e8f2a0[<br />  name=Electronic<br />  type=ELECTRONIC<br />  price=1000.0<br />  countryOfOrigin=PL<br />  additionalInfo=&lt;null&gt;<br />  quantity=10<br />]<br />pl.grzejszczak.marcin.drools.decisiontable.service.drools.ProductServiceImplTest:150 pl.grzejszczak.marcin.drools.decisiontable.model.User@b28f30[<br />  userName=Smith<br />  userAge=19<br />  userCountry=PL<br />  decision=&lt;null&gt;<br />  decisionDescription=&lt;null&gt;<br />]<br />pl.grzejszczak.marcin.drools.decisiontable.service.drools.ProductServiceImplTest:151 pl.grzejszczak.marcin.drools.decisiontable.model.Product@d6a0e0[<br />  name=Electronic<br />  type=ELECTRONIC<br />  price=1000.0<br />  countryOfOrigin=PL<br />  additionalInfo=&lt;null&gt;<br />  quantity=1<br />]<br />pl.grzejszczak.marcin.drools.decisiontable.service.ProductServiceImpl:31 Running product logic - first acceptance Route, then discount Route<br />pl.grzejszczak.marcin.drools.decisiontable.converter.ProductTypeConverter:25 Executing ProductTypeConverter's toCommandFromList method<br />pl.grzejszczak.marcin.drools.decisiontable.service.ProductService:8 Congratulations, you have successfully bought the product<br />pl.grzejszczak.marcin.drools.decisiontable.converter.ProductTypeConverter:25 Executing ProductTypeConverter's toCommandFromList method<br />pl.grzejszczak.marcin.drools.decisiontable.service.ProductService:8 Sorry, no discount will be granted.<br />pl.grzejszczak.marcin.drools.decisiontable.service.FinancialServiceImpl:25 User has been approved - processing the order...<br />pl.grzejszczak.marcin.drools.decisiontable.service.drools.ProductServiceImplTest:150 pl.grzejszczak.marcin.drools.decisiontable.model.User@b28f30[<br />  userName=Smith<br />  userAge=19<br />  userCountry=PL<br />  decision=ACCEPTED<br />  decisionDescription=Congratulations, you have successfully bought the product<br />]<br />pl.grzejszczak.marcin.drools.decisiontable.service.drools.ProductServiceImplTest:151 pl.grzejszczak.marcin.drools.decisiontable.model.Product@d6a0e0[<br />  name=Electronic<br />  type=ELECTRONIC<br />  price=1000.0<br />  countryOfOrigin=PL<br />  additionalInfo=Sorry, no discount will be granted.<br />  quantity=1<br />]<br />pl.grzejszczak.marcin.drools.decisiontable.service.drools.ProductServiceImplTest:150 pl.grzejszczak.marcin.drools.decisiontable.model.User@14510ac[<br />  userName=Smith<br />  userAge=19<br />  userCountry=PL<br />  decision=&lt;null&gt;<br />  decisionDescription=&lt;null&gt;<br />]<br />pl.grzejszczak.marcin.drools.decisiontable.service.drools.ProductServiceImplTest:151 pl.grzejszczak.marcin.drools.decisiontable.model.Product@1499616[<br />  name=Electronic<br />  type=ELECTRONIC<br />  price=1000.0<br />  countryOfOrigin=PL<br />  additionalInfo=&lt;null&gt;<br />  quantity=8<br />]<br />pl.grzejszczak.marcin.drools.decisiontable.service.ProductServiceImpl:31 Running product logic - first acceptance Route, then discount Route<br />pl.grzejszczak.marcin.drools.decisiontable.converter.ProductTypeConverter:25 Executing ProductTypeConverter's toCommandFromList method<br />pl.grzejszczak.marcin.drools.decisiontable.service.ProductService:8 Congratulations, you have successfully bought the product<br />pl.grzejszczak.marcin.drools.decisiontable.converter.ProductTypeConverter:25 Executing ProductTypeConverter's toCommandFromList method<br />pl.grzejszczak.marcin.drools.decisiontable.service.ProductService:8 Congratulations - you've been granted a 10% discount!<br />pl.grzejszczak.marcin.drools.decisiontable.service.FinancialServiceImpl:25 User has been approved - processing the order...<br />pl.grzejszczak.marcin.drools.decisiontable.service.drools.ProductServiceImplTest:150 pl.grzejszczak.marcin.drools.decisiontable.model.User@14510ac[<br />  userName=Smith<br />  userAge=19<br />  userCountry=PL<br />  decision=ACCEPTED<br />  decisionDescription=Congratulations, you have successfully bought the product<br />]<br />pl.grzejszczak.marcin.drools.decisiontable.service.drools.ProductServiceImplTest:151 pl.grzejszczak.marcin.drools.decisiontable.model.Product@1499616[<br />  name=Electronic<br />  type=ELECTRONIC<br />  price=900.0<br />  countryOfOrigin=PL<br />  additionalInfo=Congratulations - you've been granted a 10% discount!<br />  quantity=8<br />]<br />pl.grzejszczak.marcin.drools.decisiontable.service.drools.ProductServiceImplTest:150 pl.grzejszczak.marcin.drools.decisiontable.model.User@17667bd[<br />  userName=Smith<br />  userAge=19<br />  userCountry=USA<br />  decision=&lt;null&gt;<br />  decisionDescription=&lt;null&gt;<br />]<br />pl.grzejszczak.marcin.drools.decisiontable.service.drools.ProductServiceImplTest:151 pl.grzejszczak.marcin.drools.decisiontable.model.Product@ad9f5d[<br />  name=Electronic<br />  type=ELECTRONIC<br />  price=1000.0<br />  countryOfOrigin=PL<br />  additionalInfo=&lt;null&gt;<br />  quantity=8<br />]<br />pl.grzejszczak.marcin.drools.decisiontable.service.ProductServiceImpl:31 Running product logic - first acceptance Route, then discount Route<br />pl.grzejszczak.marcin.drools.decisiontable.converter.ProductTypeConverter:25 Executing ProductTypeConverter's toCommandFromList method<br />pl.grzejszczak.marcin.drools.decisiontable.service.ProductService:8 Sorry, according to your age (&lt; 18) and country (USA) you can't buy this product<br />pl.grzejszczak.marcin.drools.decisiontable.converter.ProductTypeConverter:25 Executing ProductTypeConverter's toCommandFromList method<br />pl.grzejszczak.marcin.drools.decisiontable.service.FinancialServiceImpl:29 Sorry, user has been rejected...<br />pl.grzejszczak.marcin.drools.decisiontable.service.drools.ProductServiceImplTest:150 pl.grzejszczak.marcin.drools.decisiontable.model.User@17667bd[<br />  userName=Smith<br />  userAge=19<br />  userCountry=USA<br />  decision=REJECTED<br />  decisionDescription=Sorry, according to your age (&lt; 18) and country (USA) you can't buy this product<br />]<br />pl.grzejszczak.marcin.drools.decisiontable.service.drools.ProductServiceImplTest:151 pl.grzejszczak.marcin.drools.decisiontable.model.Product@ad9f5d[<br />  name=Electronic<br />  type=ELECTRONIC<br />  price=1000.0<br />  countryOfOrigin=PL<br />  additionalInfo=&lt;null&gt;<br />  quantity=8<br />]<br />pl.grzejszczak.marcin.drools.decisiontable.service.drools.ProductServiceImplTest:150 pl.grzejszczak.marcin.drools.decisiontable.model.User@9ff588[<br />  userName=Smith<br />  userAge=22<br />  userCountry=USA<br />  decision=&lt;null&gt;<br />  decisionDescription=&lt;null&gt;<br />]<br />pl.grzejszczak.marcin.drools.decisiontable.service.drools.ProductServiceImplTest:151 pl.grzejszczak.marcin.drools.decisiontable.model.Product@1b0d2d0[<br />  name=Some name<br />  type=MEDICAL<br />  price=1000.0<br />  countryOfOrigin=SWE<br />  additionalInfo=&lt;null&gt;<br />  quantity=4<br />]<br />pl.grzejszczak.marcin.drools.decisiontable.service.ProductServiceImpl:31 Running product logic - first acceptance Route, then discount Route<br />pl.grzejszczak.marcin.drools.decisiontable.converter.ProductTypeConverter:25 Executing ProductTypeConverter's toCommandFromList method<br />pl.grzejszczak.marcin.drools.decisiontable.service.ProductService:8 Congratulations, you have successfully bought the product<br />pl.grzejszczak.marcin.drools.decisiontable.converter.ProductTypeConverter:25 Executing ProductTypeConverter's toCommandFromList method<br />pl.grzejszczak.marcin.drools.decisiontable.service.FinancialServiceImpl:25 User has been approved - processing the order...<br />pl.grzejszczak.marcin.drools.decisiontable.service.drools.ProductServiceImplTest:150 pl.grzejszczak.marcin.drools.decisiontable.model.User@9ff588[<br />  userName=Smith<br />  userAge=22<br />  userCountry=USA<br />  decision=ACCEPTED<br />  decisionDescription=Congratulations, you have successfully bought the product<br />]<br />pl.grzejszczak.marcin.drools.decisiontable.service.drools.ProductServiceImplTest:151 pl.grzejszczak.marcin.drools.decisiontable.model.Product@1b0d2d0[<br />  name=Some name<br />  type=MEDICAL<br />  price=1000.0<br />  countryOfOrigin=SWE<br />  additionalInfo=&lt;null&gt;<br />  quantity=4<br />]<br />pl.grzejszczak.marcin.drools.decisiontable.service.drools.ProductServiceImplTest:150 pl.grzejszczak.marcin.drools.decisiontable.model.User@1b27882[<br />  userName=Smith<br />  userAge=22<br />  userCountry=USA<br />  decision=&lt;null&gt;<br />  decisionDescription=&lt;null&gt;<br />]<br />pl.grzejszczak.marcin.drools.decisiontable.service.drools.ProductServiceImplTest:151 pl.grzejszczak.marcin.drools.decisiontable.model.Product@5b84b[<br />  name=Some name<br />  type=MEDICAL<br />  price=1000.0<br />  countryOfOrigin=SWE<br />  additionalInfo=&lt;null&gt;<br />  quantity=8<br />]<br />pl.grzejszczak.marcin.drools.decisiontable.service.ProductServiceImpl:31 Running product logic - first acceptance Route, then discount Route<br />pl.grzejszczak.marcin.drools.decisiontable.converter.ProductTypeConverter:25 Executing ProductTypeConverter's toCommandFromList method<br />pl.grzejszczak.marcin.drools.decisiontable.service.ProductService:8 Congratulations, you have successfully bought the product<br />pl.grzejszczak.marcin.drools.decisiontable.converter.ProductTypeConverter:25 Executing ProductTypeConverter's toCommandFromList method<br />pl.grzejszczak.marcin.drools.decisiontable.service.ProductService:8 Congratulations, you are granted a discount<br />pl.grzejszczak.marcin.drools.decisiontable.service.FinancialServiceImpl:25 User has been approved - processing the order...<br />pl.grzejszczak.marcin.drools.decisiontable.service.drools.ProductServiceImplTest:150 pl.grzejszczak.marcin.drools.decisiontable.model.User@1b27882[<br />  userName=Smith<br />  userAge=22<br />  userCountry=USA<br />  decision=ACCEPTED<br />  decisionDescription=Congratulations, you have successfully bought the product<br />]<br />pl.grzejszczak.marcin.drools.decisiontable.service.drools.ProductServiceImplTest:151 pl.grzejszczak.marcin.drools.decisiontable.model.Product@5b84b[<br />  name=Some name<br />  type=MEDICAL<br />  price=750.0<br />  countryOfOrigin=SWE<br />  additionalInfo=Congratulations, you are granted a discount<br />  quantity=8<br />]<br /><br /></pre><span style="text-align: justify;">In this post I've presented how you can push some of your developing work to your BA by giving him a tool which he can be able to work woth - the Decision Tables in a spreadsheet. What is more now you will now how to integrate Drools with Camel. Hopefully you will see how you can simplify (thus minimize the cost of implementing and supporting) the implementation of business rules bearing in mind how prone to changes they are. I hope that this example will even better illustrate how difficult it would be to implement all the business rules in Java than in the <a href="https://toomuchcoding.blogspot.com/2013/01/drools-integration-with-spring-vs.html">previous post about Drools.</a></span><br /><span style="text-align: justify;"><br /></span><span style="text-align: justify;">If you have any experience with Drools in terms of decision tables, integration with Spring and Camel please feel free to leave a comment - let's have a discussion on that :)</span><br /><span style="text-align: justify;"><br /></span><span style="text-align: justify;">All the code is available at Too Much Coding repository at <a href="https://bitbucket.org/gregorin1987/too-much-coding/src/eeda79f74a4af30091490ab3507879254540e118/Drools/Decision%20table?at=default">Bitbucket </a>and <a href="https://github.com/marcingrzejszczak/too-much-coding/tree/master/Drools/Decision%20table">GitHub</a>.</span><span style="text-align: justify;"><br /></span><br /><span style="text-align: justify;"><br /></span><span style="text-align: justify;">Cheers!</span></div>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        










<span class="glyphicon glyphicon-calendar"></span> <time datetime="2013-01-28T01:20:00-08:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
           | <a href="/articles/2013/01/28/concurrency-in-web-applications/#disqus_thread" itemprop="discussionUrl"
             data-disqus-identifier="https://toomuchcoding.com/articles/2013/01/28/concurrency-in-web-applications/">Comments</a>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/articles/2013/01/28/concurrency-in-web-applications/" itemprop="url">Concurrency in web applications</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><div class='post'>
Nice article about <a href="https://blog.atena.pl/zrownoleglenie-operacji-w-aplikacji-webowej-2">concurrency in web applications (in Polish)</a></div>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        










<span class="glyphicon glyphicon-calendar"></span> <time datetime="2013-01-23T03:48:00-08:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
           | <a href="/articles/2013/01/23/drools-rete-alogrithm-explanation/#disqus_thread" itemprop="discussionUrl"
             data-disqus-identifier="https://toomuchcoding.com/articles/2013/01/23/drools-rete-alogrithm-explanation/">Comments</a>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/articles/2013/01/23/drools-rete-alogrithm-explanation/" itemprop="url">Drools - Rete Alogrithm explanation</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><div class='post'>
Quite recently I have found <a href="https://salaboy.com/2011/06/06/drools-reteoo-for-dummies-1-intro/">a very nice article about the Rete Algorithm.</a></div>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        










<span class="glyphicon glyphicon-calendar"></span> <time datetime="2013-01-17T11:06:00-08:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
           | <a href="/articles/2013/01/17/new-too-much-coding-repository/#disqus_thread" itemprop="discussionUrl"
             data-disqus-identifier="https://toomuchcoding.com/articles/2013/01/17/new-too-much-coding-repository/">Comments</a>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/articles/2013/01/17/new-too-much-coding-repository/" itemprop="url">New Too Much Coding repository!</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><div class='post'>
Hi!<br /><br />As you know there is a code repository of <a href="https://bitbucket.org/gregorin1987/too-much-coding/src">Too Much Coding sources here at Bitbucket</a>. If you don't like it you can also find the <a href="https://github.com/marcingrzejszczak/too-much-coding">Too Much Coding sources at GitHub!</a><br /><br />Enjoy :)</div>
</div>
  
  


        </article>
      
    </div>

    <ul class="pager">
      
        <li class="previous"><a href="/posts/6">&larr;&nbsp;Older</a></li>
      
      <li><a href="/blog/archives">Blog Archives</a></li>
      
        <li class="next"><a href="/posts/4">Newer&nbsp;&rarr;</a></li>
      
    </ul>
  </div>

  
    <aside class="sidebar col-md-3">
        <section>
  <h1>About Me</h1>
  <p><img src="/images/ja.jpeg" style="float:left;margin:5px;border-width:0px;width:100%;height:100%"/>
  Co-author of <a href="https://smarttesting.pl">SmartTesting</a>, author of <a href="https://learning.oreilly.com/videos/hands-on-guide-to/9780135598436">Hands-On Guide to Spring Cloud Contract: Creating Consumer-Driven Contracts to Leverage Contract Tests and Improve Your Code</a> and co-author of <a href="https://bit.ly/appliedCD">Applied Continuous Delivery Live Lessons</a>. Co-founder of the Warsaw Groovy User Group, <a href="https://www.meetup.com/Warsaw-Cloud-Native-Meetup/">Warsaw Cloud Native Meetup</a> and the <a href="https://www.diverseit.io">DiverseIT</a> initiative. Author of <a href="https://www.packtpub.com/application-development/instant-mockito">"Mockito Instant"</a> and <a href="https://www.packtpub.com/application-development/mockito-cookbook">"Mockito Cookbook"</a> books.
  </p>

  <a>
  Working on Spring Observability, <a href="https://spring.io/projects/spring-cloud-sleuth/">Spring Cloud Sleuth</a>, <a href="https://spring.io/projects/spring-cloud-contract/">Spring Cloud Contract</a> projects at <a href="https://spring.io/">VMware</a>.
  </p>

  <p><a href="https://github.com/marcingrzejszczak">Github profile</a></p>
  
  <p><a rel="me" href="https://fosstodon.org/@toomuchcoding">Mastodon</a></p>

  <p><a href="https://twitter.com/MGrzejszczak">Twitter: @MGrzejszczak (please follow the Mastodon account - I'm moving off Twitter)</a></p>

  <p><a href="https://www.goodreads.com/author/show/7284553.Marcin_Grzejszczak">Goodreads account</a></p>
</section>

      </aside>
  
</div>

        </div>
      </div>
    </div>
    <footer role="contentinfo"><div class="container">
    <p class="text-muted credits">
  Copyright &copy; 2022 - Marcin Grzejszczak<br>
  <small>
      <span class="credit">Powered by <a href="https://octopress.org">Octopress</a></span>,
      <span class="credit">customized with <a href="https://github.com/kAworu/octostrap3">octostrap3</a></span>.
  </small>
</p>

</div>
</footer>
    

<script type="text/javascript">
      var disqus_shortname = 'toomuchcoding';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


<script src="/assets/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/javascripts/modernizr.js"></script>


  </body>
</html>
