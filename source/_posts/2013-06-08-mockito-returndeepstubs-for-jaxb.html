---
layout: post
comments: true
title: "Mockito - RETURNS_DEEP_STUBS for JAXB"
date: 2013-06-08T12:10:00-07:00
categories:
 - Mockito
 - RETURNS_DEEP_STUBS
 - JAXB
---

<div class='post'>
<br />Sorry for not having written for some time but I was busy with writing the JBoss Drools Refcard for DZone and I am in the middle of writing a book about Mockito so I don't have too much time left for blogging...<br />
<!--more-->
<br />Anyway quite recently on my current project I had an interesting situation regarding unit testing with Mockito and JAXB structures. We have very deeply nested JAXB structures generated from schemas that are provided for us which means that we can't change it in anyway.<br /><br /><a name='more'></a><br /><br />Let's take a look at the project structure:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-V5rYljCB5V4/UbN2mTKQ_QI/AAAAAAAABY8/C4WL8Tg-9b8/s1600/project_structure.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="320" src="https://1.bp.blogspot.com/-V5rYljCB5V4/UbN2mTKQ_QI/AAAAAAAABY8/C4WL8Tg-9b8/s320/project_structure.jpg" width="173" /></a></div><br />The project structure is pretty simple - there is a <b>Player.xsd</b> schema file that thanks to using the&nbsp;<b>jaxb2-maven-plugin</b>&nbsp;produces the generated JAXB Java classes corresponding to the schema in the <b>target/jaxb/</b> folder in the appropriate package that is defined in the <b>pom.xml</b>. Speaking of which let's take a look at the <b>pom.xml</b> file.<br /><br />The pom.xml :<br /><br /><pre class="brush:xml">&lt;project xmlns="https://maven.apache.org/POM/4.0.0" xmlns:xsi="https://www.w3.org/2001/XMLSchema-instance"<br /> xsi:schemaLocation="https://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;<br /> &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;<br /> &lt;groupId&gt;com.blogspot.toomuchcoding&lt;/groupId&gt;<br /> &lt;artifactId&gt;mockito-deep_stubs&lt;/artifactId&gt;<br /> &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;<br /><br /> &lt;properties&gt;<br />  &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;<br />  &lt;maven.compiler.source&gt;1.6&lt;/maven.compiler.source&gt;<br />  &lt;maven.compiler.target&gt;1.6&lt;/maven.compiler.target&gt;<br /> &lt;/properties&gt;<br /> &lt;repositories&gt;<br />  &lt;repository&gt;<br />   &lt;id&gt;spring-release&lt;/id&gt;<br />   &lt;url&gt;https://maven.springframework.org/release&lt;/url&gt;<br />  &lt;/repository&gt;<br />  &lt;repository&gt;<br />   &lt;id&gt;maven-us-nuxeo&lt;/id&gt;<br />   &lt;url&gt;https://maven-us.nuxeo.org/nexus/content/groups/public&lt;/url&gt;<br />  &lt;/repository&gt;<br /> &lt;/repositories&gt;<br /><br /> &lt;dependencies&gt;<br />  &lt;dependency&gt;<br />   &lt;groupId&gt;junit&lt;/groupId&gt;<br />   &lt;artifactId&gt;junit&lt;/artifactId&gt;<br />   &lt;version&gt;4.10&lt;/version&gt;<br />  &lt;/dependency&gt;<br />  &lt;dependency&gt;<br />            &lt;groupId&gt;org.mockito&lt;/groupId&gt;<br />            &lt;artifactId&gt;mockito-all&lt;/artifactId&gt;<br />            &lt;version&gt;1.9.5&lt;/version&gt;<br />            &lt;scope&gt;test&lt;/scope&gt;<br />        &lt;/dependency&gt;<br /> &lt;/dependencies&gt;<br /> <br /> <br />    &lt;build&gt;<br />        &lt;pluginManagement&gt;<br />            &lt;plugins&gt;<br />                &lt;plugin&gt;<br />                    &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;<br />                    &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;<br />                    &lt;version&gt;2.5.1&lt;/version&gt;<br />                &lt;/plugin&gt;<br />            &lt;/plugins&gt;<br />        &lt;/pluginManagement&gt;<br />        &lt;plugins&gt;<br />            &lt;plugin&gt;<br />                &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt;<br />                &lt;artifactId&gt;jaxb2-maven-plugin&lt;/artifactId&gt;<br />                &lt;version&gt;1.5&lt;/version&gt;<br />                &lt;executions&gt;<br />                    &lt;execution&gt;<br />                        &lt;id&gt;xjc&lt;/id&gt;<br />                        &lt;goals&gt;<br />                            &lt;goal&gt;xjc&lt;/goal&gt;<br />                        &lt;/goals&gt;<br />                    &lt;/execution&gt;<br />                &lt;/executions&gt;<br />                &lt;configuration&gt;<br />                    &lt;packageName&gt;com.blogspot.toomuchcoding.model&lt;/packageName&gt;<br />                    &lt;schemaDirectory&gt;${project.basedir}/src/main/resources/xsd&lt;/schemaDirectory&gt;<br />                &lt;/configuration&gt;<br />            &lt;/plugin&gt;<br />        &lt;/plugins&gt;<br />    &lt;/build&gt;<br /><br />&lt;/project&gt;<br /><br /></pre>Apart from the previously defined project dependencies, as mentioned previously in the <b>jaxb2-maven-plugin</b>&nbsp;in the configuration node you can define the <b>packageName</b> value that defines to which package should the JAXB classes be generated basing on the <b>schemaDirectory</b> value where the plugin can find the proper schema files.<br /><br />Speaking of which let's check the <b>Player.xsd</b> schema file (simillar to the one that was present in the <a href="https://toomuchcoding.blogspot.com/2012/11/spring-jms-message-automatic-conversion.html">Spring JMS automatic message conversion article of mine</a>):<br /><br /><pre class="brush:xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;<br />&lt;xsd:schema xmlns:xsd="https://www.w3.org/2001/XMLSchema"&gt;<br /><br />    &lt;xsd:element name="PlayerDetails"&gt;<br />        &lt;xsd:complexType&gt;<br />            &lt;xsd:sequence&gt;<br />                &lt;xsd:element name="Name" type="xsd:string"/&gt;<br />                &lt;xsd:element name="Surname" type="xsd:string"/&gt;<br />                &lt;xsd:element name="Position" type="PositionType"/&gt;<br />                &lt;xsd:element name="Age" type="xsd:int"/&gt;<br />                &lt;xsd:element name="ClubDetails" type="ClubDetails"/&gt;<br />            &lt;/xsd:sequence&gt;<br />        &lt;/xsd:complexType&gt;<br />    &lt;/xsd:element&gt;<br /><br />    &lt;xsd:complexType name="ClubDetails"&gt;<br />        &lt;xsd:sequence&gt;<br />            &lt;xsd:element name="TeamName" type="xsd:string"/&gt;<br />            &lt;xsd:element name="Country" type="CountryDetails"/&gt;<br />        &lt;/xsd:sequence&gt;<br />    &lt;/xsd:complexType&gt;<br /><br />    &lt;xsd:complexType name="CountryDetails"&gt;<br />        &lt;xsd:sequence&gt;<br />            &lt;xsd:element name="CountryName" type="xsd:string"/&gt;<br />            &lt;xsd:element name="CountryCode" type="CountryCodeDetails"/&gt;<br />        &lt;/xsd:sequence&gt;<br />    &lt;/xsd:complexType&gt;<br /><br />    &lt;xsd:complexType name="CountryCodeDetails"&gt;<br />        &lt;xsd:sequence&gt;<br />            &lt;xsd:element name="CountryName" type="xsd:string"/&gt;<br />            &lt;xsd:element name="CountryCode" type="CountryCodeType"/&gt;<br />        &lt;/xsd:sequence&gt;<br />    &lt;/xsd:complexType&gt;<br /><br />    &lt;xsd:simpleType name="CountryCodeType"&gt;<br />        &lt;xsd:restriction base="xsd:string"&gt;<br />            &lt;xsd:enumeration value="PL"/&gt;<br />            &lt;xsd:enumeration value="GER"/&gt;<br />            &lt;xsd:enumeration value="FRA"/&gt;<br />            &lt;xsd:enumeration value="ENG"/&gt;<br />            &lt;xsd:enumeration value="ESP"/&gt;<br />        &lt;/xsd:restriction&gt;<br />    &lt;/xsd:simpleType&gt;<br /><br />    &lt;xsd:simpleType name="PositionType"&gt;<br />        &lt;xsd:restriction base="xsd:string"&gt;<br />            &lt;xsd:enumeration value="GK"/&gt;<br />            &lt;xsd:enumeration value="DEF"/&gt;<br />            &lt;xsd:enumeration value="MID"/&gt;<br />            &lt;xsd:enumeration value="ATT"/&gt;<br />        &lt;/xsd:restriction&gt;<br />    &lt;/xsd:simpleType&gt;<br /><br />&lt;/xsd:schema&gt;<br /></pre><br />As you can see I'm defining some complex types that even though might have no business sense but you can find such examples in the real life :)<br /><br />Let's find out how the method that we would like to test looks like. Here we have the <b>PlayerServiceImpl</b> that implements the <b>PlayerService</b> interface:<br /><br /><pre class="brush:java">package com.blogspot.toomuchcoding.service;<br /><br />import com.blogspot.toomuchcoding.model.PlayerDetails;<br /><br />/**<br /> * User: mgrzejszczak<br /> * Date: 08.06.13<br /> * Time: 19:02<br /> */<br />public class PlayerServiceImpl implements PlayerService {<br />    @Override<br />    public boolean isPlayerOfGivenCountry(PlayerDetails playerDetails, String country) {<br />        String countryValue = playerDetails.getClubDetails().getCountry().getCountryCode().getCountryCode().value();<br />        return countryValue.equalsIgnoreCase(country);<br />    }<br />}<br /></pre><br />We are getting the nested elements from the JAXB generated classes. Although it violates the <a href="https://en.wikipedia.org/wiki/Law_of_Demeter">Law of Demeter</a>&nbsp;it is quite common to call methods of <b>structures</b>&nbsp;because JAXB generated classes are in fact structures so in fact I fully agree with <a href="https://martinfowler.com/articles/mocksArentStubs.html">Martin Fowler that it should be called the Suggestion of Demeter</a>. Anyway let's see how you could test the method:<br /><br /><pre class="brush:java">    @Test<br />    public void shouldReturnTrueIfCountryCodeIsTheSame() throws Exception {<br />        //given<br />        PlayerDetails playerDetails = new PlayerDetails();<br />        ClubDetails clubDetails = new ClubDetails();<br />        CountryDetails countryDetails = new CountryDetails();<br />        CountryCodeDetails countryCodeDetails = new CountryCodeDetails();<br />        playerDetails.setClubDetails(clubDetails);<br />        clubDetails.setCountry(countryDetails);<br />        countryDetails.setCountryCode(countryCodeDetails);<br />        countryCodeDetails.setCountryCode(CountryCodeType.ENG);<br /><br />        //when<br />        boolean playerOfGivenCountry = objectUnderTest.isPlayerOfGivenCountry(playerDetails, COUNTRY_CODE_ENG);<br /><br />        //then<br />        assertThat(playerOfGivenCountry, is(true));<br />    }<br /></pre>The function checks if, once you have the same Country Code, you get a true boolean from the method. The only problem is the amount of sets and instantiations that take place when you want to create the input message. In our projects we have twice as many nested elements so you can only imagine the number of code that we would have to produce to create the input object...<br /><br />So what can be done to improve this code? Mockito comes to the rescue to together with the <b>RETURN_DEEP_STUBS</b> default answer to the <b><a href="https://docs.mockito.googlecode.com/hg/org/mockito/Mockito.html#mock(java.lang.Class, org.mockito.stubbing.Answer)">Mockito.mock(...)</a></b> method:<br /><br /><pre class="brush:java">  @Test<br />    public void shouldReturnTrueIfCountryCodeIsTheSameUsingMockitoReturnDeepStubs() throws Exception {<br />        //given<br />        PlayerDetails playerDetailsMock = mock(PlayerDetails.class, RETURNS_DEEP_STUBS);<br />        CountryCodeType countryCodeType = CountryCodeType.ENG;<br />        when(playerDetailsMock.getClubDetails().getCountry().getCountryCode().getCountryCode()).thenReturn(countryCodeType);<br /><br />        //when<br />        boolean playerOfGivenCountry = objectUnderTest.isPlayerOfGivenCountry(playerDetailsMock, COUNTRY_CODE_ENG);<br /><br />        //then<br />        assertThat(playerOfGivenCountry, is(true));<br />    }<br /></pre>So what happened here is that you use the <b>Mockito.mock(...)</b> method and provide the <b>RETURNS_DEEP_STUBS</b> answer that will create mocks automatically for you. Mind you that Enums can't be mocked that's why you can't write in the <b>Mockito.when(...)</b> function <b>playerDetailsMock.getClubDetails().getCountry().getCountryCode().getCountryCode().getValue()</b>.<br /><br />Summing it up you can compare the readability of both tests and see how clearer it is to work with JAXB structures by using Mockito <b>RETURNS_DEEP_STUBS</b> default answer.<br /><br />Naturally sources for this example are available at <a href="https://bitbucket.org/gregorin1987/too-much-coding/src/fc1bc010cf16e1f6477391f54e83f8ad446f7608/Unit%20Testing/Mockito%20-%20Deep%20Stubs?at=default">BitBucket</a> and <a href="https://github.com/marcingrzejszczak/too-much-coding/tree/master/Unit%20Testing/Mockito%20-%20Deep%20Stubs">GitHub</a>.<br /><br /><br /></div>
